# Milestone v2.0: LangExtract & CloudBuild

**Status:** âœ… SHIPPED 2026-01-25
**Phases:** 10-18
**Total Plans:** 28

## Overview

Add LangExtract-based extraction pipeline with character-level source grounding, optional LightOnOCR GPU service for scanned documents, and migrate from Terraform to CloudBuild + CLI deployment.

**Core Features:**
- LangExtract + Gemini 3.0 Flash extraction with character-level offsets
- LightOnOCR Cloud Run service with L4 GPU for scanned document OCR
- Dual extraction method support (Docling + LangExtract) with API selection
- Complete infrastructure migration from Terraform to CloudBuild + gcloud CLI
- Few-shot example-based extraction schema for loan documents

## Phases

### Phase 10: v2.0 Setup & Preparation

**Goal**: Prepare infrastructure and prerequisites for v2.0 development (GPU quota, Terraform archival, CloudBuild foundation)
**Depends on**: v1.0 complete
**Requirements**: LOCR-09, CBLD-04, CBLD-08, CBLD-12
**Plans**: 5 plans

Plans:
- [x] 10-01: GPU quota check and request
- [x] 10-02: Terraform state archival
- [x] 10-03: CloudBuild service account setup
- [x] 10-04: vLLM validation scripts and testing
- [x] 10-05: Gap closure - Execute CloudBuild service account script

**Details:**
- L4 GPU quota verified (1 GPU in us-central1, sufficient for scale-to-zero)
- Terraform state archived to archive/terraform/ with complete documentation (33 resources)
- CloudBuild service account created with 5 least-privilege IAM roles
- vLLM validation deferred to Phase 13 cloud deployment (no local GPU)

### Phase 11: LangExtract Core Integration

**Goal**: Integrate LangExtract with Gemini 3.0 Flash for character-level source-grounded extraction
**Depends on**: Phase 10
**Requirements**: LXTR-01, LXTR-02, LXTR-03, LXTR-04, LXTR-05, LXTR-08, LXTR-09, LXTR-12
**Plans**: 4 plans

Plans:
- [x] 11-01: Schema updates (char_start/char_end in SourceReference)
- [x] 11-02: Few-shot examples for LangExtract
- [x] 11-03: LangExtractProcessor and OffsetTranslator
- [x] 11-04: Verification tests for character offsets

**Details:**
- SourceReference model extended with nullable char_start/char_end for backward compatibility
- 6 few-shot examples created with verbatim extraction_text validation
- LangExtractProcessor uses LANGEXTRACT_API_KEY (mapped from GOOGLE_API_KEY)
- OffsetTranslator uses difflib.SequenceMatcher for Docling markdown alignment
- Character offsets verified via programmatic substring matching

### Phase 12: LangExtract Advanced Features

**Goal**: Complete LangExtract capabilities with multi-pass extraction, visualization, and parallel processing
**Depends on**: Phase 11
**Requirements**: LXTR-06, LXTR-07, LXTR-10, LXTR-11
**Plans**: 3 plans

Plans:
- [x] 12-01: ExtractionConfig and LangExtractProcessor enhancement
- [x] 12-02: LangExtractVisualizer for HTML visualization
- [x] 12-03: ExtractionRouter with fallback to Docling

**Details:**
- ExtractionConfig dataclass with __post_init__ validation (2-5 passes, 1-50 workers)
- LangExtractVisualizer uses lx.visualize() for HTML with overlapping spans
- ExtractionRouter with retry logic (transient errors: 3x exponential backoff, fatal errors: immediate fallback)
- method='auto' tries LangExtract first, falls back to Docling on failure

### Phase 13: LightOnOCR GPU Service

**Goal**: Deploy dedicated Cloud Run GPU service with LightOnOCR model for high-quality scanned document OCR
**Depends on**: Phase 10 (GPU quota)
**Requirements**: LOCR-01, LOCR-02, LOCR-03, LOCR-04, LOCR-06, LOCR-07, LOCR-08, LOCR-10, LOCR-12
**Plans**: 3 plans

Plans:
- [x] 13-01: Docker image and deployment scripts
- [x] 13-02: Deploy GPU service to Cloud Run
- [x] 13-03: LightOnOCRClient backend implementation

**Details:**
- vLLM v0.11.2 base image with transformers 4.57.1 for LightOnOCR-2-1B compatibility
- Model baked into Docker image for faster cold starts
- 8 vCPU, 32Gi memory, L4 GPU, 240s startup probe, GPU memory 80%, max_seqs=8
- Cloud Build used for GPU image build (local disk space constraints)
- LightOnOCRClient uses id_token.fetch_id_token for OIDC auth, 120s timeout
- Scale-to-zero enabled (min_instances=0) for $0 baseline cost

**Note:** Monitoring/metrics deferred as operational enhancement (LOCR-08, LOCR-12 - basic logging sufficient)

### Phase 14: OCR Routing & Fallback

**Goal**: Implement intelligent OCR routing with scanned document detection and Docling fallback
**Depends on**: Phase 13
**Requirements**: LOCR-05, LOCR-11
**Plans**: 2 plans

Plans:
- [x] 14-01: ScannedDocumentDetector with pypdfium2
- [x] 14-02: OCRRouter with circuit breaker and fallback

**Details:**
- MIN_CHARS_THRESHOLD=50, SCANNED_RATIO_THRESHOLD=0.5 for scanned detection
- pypdfium2 (via Docling) for text extraction - no new dependencies
- Circuit breaker: fail_max=3, timeout_duration=60s (aiobreaker)
- OCR modes: auto (detect), force (always OCR), skip (never OCR)
- Conservative error handling: assume scanned on parse failures

### Phase 15: Dual Pipeline Integration

**Goal**: Enable API-based extraction method selection with consistent output across pipelines
**Depends on**: Phase 12, Phase 14
**Requirements**: DUAL-01 through DUAL-11
**Plans**: 2 plans

Plans:
- [x] 15-01: Database schema + API query parameters
- [x] 15-02: Cloud Tasks enhancement + service wiring

**Details:**
- Document model with extraction_method and ocr_processed columns (nullable for backward compatibility)
- Alembic migration 003_add_extraction_metadata.py
- ExtractionMethod includes 'auto' option, default='docling' preserves v1.0 behavior (DUAL-09)
- OCRRouter runs BEFORE extraction when ocr != 'skip' (DUAL-04)
- Cloud Tasks payload enhanced with method/ocr parameters
- 6 integration tests verify character offset population (DUAL-08)

### Phase 16: CloudBuild Deployment

**Goal**: Migrate from Terraform to CloudBuild + gcloud CLI for all service deployments
**Depends on**: Phase 13 (GPU service), Phase 15 (services complete)
**Requirements**: CBLD-01, CBLD-02, CBLD-03, CBLD-05, CBLD-06, CBLD-07, CBLD-09, CBLD-10, CBLD-11
**Plans**: 3 plans

Plans:
- [x] 16-01: CloudBuild configuration files
- [x] 16-02: Infrastructure scripts (provision, rollback, Terraform inventory)
- [x] 16-03: GitHub triggers and deployment guide

**Details:**
- CloudBuild configs for backend, frontend, GPU services with Secret Manager integration
- infrastructure/scripts/provision-infra.sh with idempotent gcloud commands
- infrastructure/scripts/rollback.sh for Cloud Run service rollback
- docs/terraform-to-gcloud-inventory.md mapping 28 Terraform resources to gcloud equivalents
- GitHub trigger setup script (manual GitHub connection required in Cloud Console)

### Phase 17: Testing & Quality

**Goal**: Achieve comprehensive test coverage for all v2.0 features with type safety
**Depends on**: Phase 15, Phase 16
**Requirements**: TEST-01 through TEST-12
**Plans**: 3 plans

Plans:
- [x] 17-01: Fix broken tests and mypy errors
- [x] 17-02: Few-shot validation tests and E2E LangExtract tests
- [x] 17-03: GPU cold start tests and final verification

**Details:**
- mypy overrides with follow_imports=skip for untyped libraries (aiobreaker, langextract)
- backend/tests/unit/extraction/test_few_shot_examples.py (17 tests)
- backend/tests/integration/test_e2e_langextract.py (8 tests)
- backend/tests/unit/ocr/test_gpu_cold_start.py (14 tests)
- Final metrics: 490 passed, 1 skipped, 86.98% coverage, 0 mypy errors

### Phase 18: Documentation & Frontend

**Goal**: Complete v2.0 documentation and frontend extraction method selection UI
**Depends on**: Phase 17
**Requirements**: DOCS-01 through DOCS-12, DUAL-10, DUAL-12
**Plans**: 3 plans

Plans:
- [x] 18-01: User guides (method selection, few-shot, GPU cost, deployment)
- [x] 18-02: ADRs and architecture documentation updates
- [x] 18-03: Frontend method/OCR selection UI

**Details:**
- docs/api/extraction-method-guide.md with curl examples
- docs/guides/few-shot-examples.md (387 lines)
- docs/guides/gpu-service-cost.md with scale-to-zero strategies
- ADRs: ADR-018 (LangExtract), ADR-019 (LightOnOCR), ADR-020 (CloudBuild)
- SYSTEM_DESIGN.md updated with dual pipeline Mermaid diagrams
- shadcn Select component for method/OCR dropdowns in UploadZone
- Default values (docling, auto) match v1.0 for backward compatibility

## Milestone Summary

### Key Decisions

- Dual extraction pipelines (Docling + LangExtract) with API-based selection
- LightOnOCR as dedicated GPU service with scale-to-zero for cost management
- CloudBuild replaces Terraform for application deployments (infrastructure via gcloud CLI)
- Terraform state remains in GCS (not copied locally) for recovery capability
- Few-shot examples use ExampleData/Extraction from langextract.data with verbatim validation
- OffsetTranslator uses difflib.SequenceMatcher for Docling markdown alignment
- Transient errors (503, 429, timeout) retry 3x, fatal errors trigger immediate fallback
- vLLM v0.11.2 with transformers from source for LightOnOCR-2-1B compatibility
- GPU memory utilization 80%, max_seqs=8 to prevent OOM on L4
- Circuit breaker: fail_max=3, timeout_duration=60s for GPU service resilience

### Issues Resolved

- GPU quota verification (1 L4 GPU sufficient for scale-to-zero)
- Terraform state archival before CloudBuild migration
- CloudBuild service account created with least-privilege IAM roles
- Character offset alignment between Docling markdown and raw text
- mypy strict compliance with untyped library overrides
- Backward compatibility maintained (default method=docling)
- GPU cold start handling (120s timeout, circuit breaker fallback)

### Issues Deferred

- Monitoring infrastructure (LOCR-08, LOCR-12) - basic logging sufficient for v2.0, custom metrics post-deployment
- LangExtractVisualizer API endpoint - component exists but not exposed in REST API (can be added later)

### Technical Debt Incurred

- LangExtractVisualizer not exposed in API endpoint (LXTR-07 satisfied, API integration deferred)
- Cold start monitoring alerts deferred to production optimization
- OCR quality metrics collection deferred to production optimization

---

_For current project status, see .planning/ROADMAP.md_
