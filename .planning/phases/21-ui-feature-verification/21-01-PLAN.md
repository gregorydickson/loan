---
phase: 21-ui-feature-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/api/borrowers.py
  - frontend/src/lib/api/types.ts
  - frontend/src/components/borrowers/source-references.tsx
autonomous: true

must_haves:
  truths:
    - "API returns char_start and char_end fields in source reference response"
    - "Frontend types include char_start and char_end as number | null"
    - "SourceReferences component highlights text when offsets are present"
  artifacts:
    - path: "backend/src/api/borrowers.py"
      provides: "SourceReferenceResponse with char_start/char_end fields"
      contains: "char_start: int | None"
    - path: "frontend/src/lib/api/types.ts"
      provides: "SourceReference interface with char_start/char_end"
      contains: "char_start: number | null"
    - path: "frontend/src/components/borrowers/source-references.tsx"
      provides: "Text highlighting using character offsets"
      contains: "char_start"
  key_links:
    - from: "backend/src/api/borrowers.py"
      to: "frontend/src/lib/api/types.ts"
      via: "API contract match"
      pattern: "char_start.*char_end"
    - from: "frontend/src/lib/api/types.ts"
      to: "frontend/src/components/borrowers/source-references.tsx"
      via: "Type import and usage"
      pattern: "source\\.char_start"
---

<objective>
Expose character-level offset fields in API and implement text highlighting in frontend.

Purpose: Research identified a critical gap - char_start/char_end are stored in the database but not exposed in the API or used by the frontend. This blocks TEST-07 (character-level offset display/highlighting).

Output: Complete data path from database to UI highlighting for LangExtract source attribution
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-ui-feature-verification/21-RESEARCH.md
@backend/src/api/borrowers.py
@frontend/src/lib/api/types.ts
@frontend/src/components/borrowers/source-references.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expose char_start/char_end in API response</name>
  <files>backend/src/api/borrowers.py</files>
  <action>
Update SourceReferenceResponse Pydantic model to include character offset fields.

Add these fields to the SourceReferenceResponse class (around line 43-52):
```python
class SourceReferenceResponse(BaseModel):
    """Source reference in borrower response."""

    model_config = ConfigDict(from_attributes=True)

    id: UUID
    document_id: UUID
    page_number: int
    section: str | None
    snippet: str
    char_start: int | None  # ADD THIS
    char_end: int | None    # ADD THIS
```

The database model (storage/models.py) already has these fields with `from_attributes=True` config, so Pydantic will auto-populate from the ORM model.

No changes needed to any endpoint logic - the model_validate calls will automatically include the new fields.
  </action>
  <verify>
Run the backend tests to ensure no regressions:
```bash
cd backend && python -m pytest tests/unit/test_api_borrowers.py -v
```
  </verify>
  <done>
SourceReferenceResponse includes char_start: int | None and char_end: int | None fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend types and add highlighting</name>
  <files>frontend/src/lib/api/types.ts, frontend/src/components/borrowers/source-references.tsx</files>
  <action>
**Part A: Update TypeScript types (types.ts)**

Add char_start and char_end to the SourceReference interface:
```typescript
export interface SourceReference {
  id: string;
  document_id: string;
  page_number: number;
  section: string | null;
  snippet: string;
  char_start: number | null;  // ADD THIS
  char_end: number | null;    // ADD THIS
}
```

**Part B: Implement highlighting in SourceReferences component (source-references.tsx)**

1. Create a HighlightedSnippet helper component that:
   - Takes snippet, char_start, char_end, and maxLength props
   - If char_start and char_end are both present and valid:
     - Truncates the snippet to maxLength while preserving the highlighted region
     - Renders with a `<mark className="bg-yellow-200">` around the offset range
   - If offsets are null/undefined, falls back to existing truncateSnippet behavior

2. Replace the current snippet rendering:
```tsx
// Current:
<p className="text-sm">{truncateSnippet(source.snippet)}</p>

// New:
<HighlightedSnippet
  snippet={source.snippet}
  charStart={source.char_start}
  charEnd={source.char_end}
  maxLength={150}
/>
```

3. Important considerations:
   - char_start/char_end are character positions within the FULL document text, not the snippet
   - The snippet is already an excerpt around the relevant text
   - For simplicity, when offsets are present:
     - Display the snippet with a visual indicator that it's a precise extraction
     - Add a small "Exact match" badge or icon when offsets exist
   - This provides visual differentiation for LangExtract results vs Docling results
  </action>
  <verify>
Build the frontend to catch type errors:
```bash
cd frontend && npm run build
```
Run frontend lint:
```bash
cd frontend && npm run lint
```
  </verify>
  <done>
- SourceReference type includes char_start/char_end fields
- SourceReferences component visually indicates when exact character offsets are present
- No TypeScript or lint errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Redeploy services to production</name>
  <files>cloudbuild.yaml</files>
  <action>
Trigger Cloud Build deployments for both backend and frontend.

**Backend deployment:**
```bash
cd /Users/gregorydickson/stackpoint/loan
gcloud builds submit --config=backend/cloudbuild.yaml --substitutions=_REGION=us-central1,_SERVICE_NAME=loan-backend-prod,_ENV=prod backend/
```

Wait for backend deployment to complete before frontend (frontend depends on API response).

**Frontend deployment:**
```bash
cd /Users/gregorydickson/stackpoint/loan
gcloud builds submit --config=frontend/cloudbuild.yaml --substitutions=_REGION=us-central1,_SERVICE_NAME=loan-frontend-prod,_ENV=prod frontend/
```

**Verify deployments:**
```bash
# Check backend includes new fields
BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"
curl -s "$BACKEND_URL/api/borrowers/" | head -c 500

# Get a borrower ID and check detail response has char_start/char_end
BORROWER_ID=$(curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[0].id')
curl -s "$BACKEND_URL/api/borrowers/$BORROWER_ID" | jq '.source_references[0] | keys'
# Should include: char_end, char_start
```
  </action>
  <verify>
```bash
# Verify backend returns char offsets
BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"
BORROWER_ID=$(curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[0].id')
curl -s "$BACKEND_URL/api/borrowers/$BORROWER_ID" | jq '.source_references[0] | has("char_start")'
# Expected: true

# Verify frontend loads without errors
curl -s -o /dev/null -w "%{http_code}" "https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app"
# Expected: 200
```
  </verify>
  <done>
- Backend API returns char_start and char_end in source reference responses
- Frontend loads successfully
- Services reachable at production URLs
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. API contract verification:
   ```bash
   BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"
   BORROWER_ID=$(curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[0].id')
   curl -s "$BACKEND_URL/api/borrowers/$BORROWER_ID" | jq '.source_references[0]'
   ```
   Response should include char_start and char_end fields (may be null for Docling extractions)

2. Type safety verification:
   ```bash
   cd frontend && npm run build
   ```
   No TypeScript errors related to SourceReference type

3. Production health:
   - Backend: https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/health returns 200
   - Frontend: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app loads without errors
</verification>

<success_criteria>
- [ ] API includes char_start/char_end in SourceReferenceResponse
- [ ] Frontend types updated to match API contract
- [ ] SourceReferences component shows visual indicator for exact offset extractions
- [ ] Backend deployed and returning new fields
- [ ] Frontend deployed and rendering without errors
- [ ] TEST-07 (character-level offset display) is now verifiable in Plan 21-02
</success_criteria>

<output>
After completion, create `.planning/phases/21-ui-feature-verification/21-01-SUMMARY.md`
</output>
