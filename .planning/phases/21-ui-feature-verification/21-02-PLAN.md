---
phase: 21-ui-feature-verification
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Source attribution UI shows page numbers for extracted fields"
    - "Character-level offsets display correctly for LangExtract results"
    - "Borrower data appears in dashboard list with correct field values"
    - "Extraction visualizations render without errors"
  artifacts:
    - path: ".planning/phases/21-ui-feature-verification/21-02-VERIFICATION.md"
      provides: "Test results for TEST-06 through TEST-09"
      contains: "TEST-06.*PASS"
  key_links:
    - from: "Production frontend"
      to: "Production backend API"
      via: "REST API calls"
      pattern: "/api/borrowers"
---

<objective>
Comprehensive Chrome-based verification of all UI features displaying extraction results.

Purpose: Final phase of v2.1 milestone - verify that source attribution, character offsets, dashboard data, and visualizations all work correctly in production.

Output: Complete verification report documenting pass/fail status for TEST-06 through TEST-09
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-ui-feature-verification/21-RESEARCH.md
@.planning/phases/21-ui-feature-verification/21-01-SUMMARY.md
</context>

<production_urls>
BACKEND_URL=https://loan-backend-prod-fjz2snvxjq-uc.a.run.app
FRONTEND_URL=https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app
</production_urls>

<tasks>

<task type="auto">
  <name>Task 1: Prepare verification data and record test candidates</name>
  <files></files>
  <action>
Before browser verification, ensure production has suitable test data and record borrower/document IDs for testing.

**Step 1: Check existing borrowers and their source references**
```bash
BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"

# List all borrowers
curl -s "$BACKEND_URL/api/borrowers/" | jq '.borrowers[] | {id, name, confidence_score, income_count}'

# Get first borrower ID
BORROWER_ID=$(curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[0].id')

# Check if borrower has source references with char offsets
curl -s "$BACKEND_URL/api/borrowers/$BORROWER_ID" | jq '{
  name: .name,
  income_count: (.income_records | length),
  source_count: (.source_references | length),
  has_char_offsets: (.source_references | any(.char_start != null))
}'
```

**Step 2: Identify and record test candidates**
- Record a borrower ID with income_records for TEST-09 (timeline)
- Record a borrower ID with source_references for TEST-06 (page numbers)
- If no borrower has char_start/char_end populated, note for TEST-07
- Record at least one document ID for document link testing

**Step 3: Create verification notes with concrete data**
```bash
# Create verification-notes.txt with test candidate IDs
echo "=== VERIFICATION TEST CANDIDATES ===" > /tmp/verification-notes.txt
echo "Generated: $(date)" >> /tmp/verification-notes.txt
echo "" >> /tmp/verification-notes.txt

# Record borrower with income for TEST-09
echo "TEST-09 Candidate (borrower with income):" >> /tmp/verification-notes.txt
curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[] | select(.income_count > 0) | "BORROWER_ID: \(.id) - \(.name) - income_count: \(.income_count)"' | head -1 >> /tmp/verification-notes.txt
echo "" >> /tmp/verification-notes.txt

# Record borrower with source refs for TEST-06
echo "TEST-06 Candidate (borrower with source refs):" >> /tmp/verification-notes.txt
FIRST_BORROWER=$(curl -s "$BACKEND_URL/api/borrowers/" | jq -r '.borrowers[0].id')
curl -s "$BACKEND_URL/api/borrowers/$FIRST_BORROWER" | jq -r '"BORROWER_ID: \(.id) - \(.name) - source_count: \(.source_references | length)"' >> /tmp/verification-notes.txt
echo "" >> /tmp/verification-notes.txt

# Record borrower with char offsets for TEST-07
echo "TEST-07 Candidate (borrower with char offsets):" >> /tmp/verification-notes.txt
curl -s "$BACKEND_URL/api/borrowers/$FIRST_BORROWER" | jq -r 'if (.source_references | any(.char_start != null)) then "BORROWER_ID: \(.id) - HAS char offsets" else "BORROWER_ID: \(.id) - NO char offsets (Docling only)" end' >> /tmp/verification-notes.txt
echo "" >> /tmp/verification-notes.txt

# Record documents
echo "Document IDs for link testing:" >> /tmp/verification-notes.txt
curl -s "$BACKEND_URL/api/documents/" | jq -r '.documents[] | "DOC_ID: \(.id) - \(.filename) - status: \(.status)"' >> /tmp/verification-notes.txt

# Output the file
cat /tmp/verification-notes.txt
```
  </action>
  <verify>
```bash
# Verify verification notes were created with borrower IDs
test -f /tmp/verification-notes.txt && grep -c "BORROWER_ID" /tmp/verification-notes.txt
# Should output a number >= 2 (at least 2 borrower ID entries)

# Also verify borrower count via API
BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"
BORROWER_COUNT=$(curl -s "$BACKEND_URL/api/borrowers/" | jq '.total')
echo "Total borrowers in production: $BORROWER_COUNT"
test "$BORROWER_COUNT" -gt 0 && echo "PASS: Borrowers exist for testing" || echo "FAIL: No borrowers - need to upload documents first"
```
  </verify>
  <done>
- verification-notes.txt created with specific borrower IDs for each test
- At least one borrower ID recorded for TEST-06 and TEST-09
- Char offset availability documented for TEST-07
- Document IDs recorded for link testing
- Verification output shows BORROWER_ID entries (count >= 2)
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <what-built>
Plan 21-01 deployed API and frontend changes that expose char_start/char_end fields and add visual badge indicator in the UI. This checkpoint verifies the core UI functionality (TEST-06, TEST-08).
  </what-built>
  <how-to-verify>
**Production URLs:**
- Frontend: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app
- Backend API: https://loan-backend-prod-fjz2snvxjq-uc.a.run.app

---

## TEST-06: Source Attribution UI Shows Page References

1. Open Chrome and navigate to: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app/borrowers
2. Click on any borrower row to open the detail page
3. Scroll to "Source Documents" card
4. **VERIFY:**
   - [ ] "Source Documents" card is visible
   - [ ] At least one source reference is displayed
   - [ ] "Page N" text shows for each reference (e.g., "Page 1", "Page 2")
   - [ ] Click document link (Document: xxxx...) - verify navigation works
   - [ ] Snippet text is displayed below page number

**Expected result:** Page numbers visible, document links functional

---

## TEST-08: Borrower Data in Dashboard

1. Navigate to: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app/borrowers
2. **VERIFY dashboard list:**
   - [ ] Table displays borrower names
   - [ ] Confidence score column shows colored badges (green/yellow/red)
   - [ ] Income count column shows numbers
   - [ ] Table is not empty (shows "No borrowers" is a FAIL if we uploaded docs)

3. **Click a borrower row for detail view:**
   - [ ] Detail page loads without error
   - [ ] Name displays correctly at top
   - [ ] Confidence badge shows appropriate color for score
   - [ ] Address displays if present (may be null)

**Expected result:** Dashboard populated with extracted borrower data, badges colored correctly

---

**Recording Results:**

For each test, note:
- PASS / FAIL / PARTIAL
- Screenshot or description of what you observed
- Any issues encountered
  </how-to-verify>
  <resume-signal>
Provide results in this format:

```
TEST-06 (Source Attribution): PASS/FAIL
- Observations: [what you saw]

TEST-08 (Dashboard): PASS/FAIL
- Observations: [what you saw]

Additional notes: [any issues]
```

If both pass, proceed to Task 3. If failures occur, document them and still proceed to get partial results.
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <what-built>
This checkpoint verifies the advanced features (TEST-07 character offsets, TEST-09 visualizations). These can be verified independently from the basic UI checks in Task 2.
  </what-built>
  <how-to-verify>
**Production URLs:**
- Frontend: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app
- Backend API: https://loan-backend-prod-fjz2snvxjq-uc.a.run.app

---

## TEST-07: Character-Level Offsets Display for LangExtract

1. Stay on borrower detail page OR navigate to a borrower with LangExtract data
2. Look at source references section
3. **VERIFY:**
   - [ ] If char_start/char_end are present in data:
     - "Exact Match" badge visible next to source reference
     - Badge styled with green background
   - [ ] If char_start/char_end are null:
     - No badge displayed (standard snippet only)
     - This is expected for Docling extractions

4. **API verification in DevTools:**
   - Open Chrome DevTools (F12) -> Network tab
   - Refresh the borrower detail page
   - Find the API call to `/api/borrowers/{id}`
   - Click it and check Response tab
   - **VERIFY:** source_references array items include `char_start` and `char_end` keys

**Expected result:** API returns char_start/char_end fields; UI shows "Exact Match" badge when offsets present

---

## TEST-09: Extraction Visualizations Render

1. Navigate to borrower detail page with income records
   (Use BORROWER_ID from Task 1 verification notes if available)
2. **VERIFY Income Timeline:**
   - [ ] "Income History" section is visible
   - [ ] Timeline renders with vertical line and dots
   - [ ] Each income record shows year and amount
   - [ ] Amounts formatted as currency (e.g., $50,000.00)

3. **VERIFY Confidence Indicator:**
   - [ ] Confidence score badge visible
   - [ ] Badge color matches score threshold:
     - >= 0.7: Green (default)
     - 0.5-0.69: Yellow (secondary)
     - < 0.5: Red (destructive)

4. **Check console for errors:**
   - Open DevTools (F12) -> Console tab
   - **VERIFY:** No red JavaScript errors related to rendering

**Expected result:** Timeline and badges render correctly, no console errors

---

**Recording Results:**

For each test, note:
- PASS / FAIL / PARTIAL
- Screenshot or description of what you observed
- Any issues encountered
  </how-to-verify>
  <resume-signal>
Provide results in this format:

```
TEST-07 (Char Offsets): PASS/FAIL/PARTIAL
- API returns char_start/char_end: YES/NO
- UI shows "Exact Match" badge: YES/NO/N/A (no data with offsets)
- Observations: [what you saw]

TEST-09 (Visualizations): PASS/FAIL
- Timeline renders: YES/NO
- Badges colored correctly: YES/NO
- Console errors: YES/NO
- Observations: [what you saw]

Additional notes: [any issues]
```
  </resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create verification report</name>
  <files>.planning/phases/21-ui-feature-verification/21-02-VERIFICATION.md</files>
  <action>
Based on human verification results from Tasks 2 and 3, create a comprehensive verification report.

Create `.planning/phases/21-ui-feature-verification/21-02-VERIFICATION.md` with:

```markdown
# Phase 21-02: UI Feature Verification Report

**Verified:** [DATE]
**Verified by:** User + Claude
**Environment:** Production (GCP Cloud Run)

## Summary

| Test | Requirement | Status | Notes |
|------|-------------|--------|-------|
| TEST-06 | Source attribution shows page references | [PASS/FAIL] | [notes] |
| TEST-07 | Character-level offsets display | [PASS/FAIL] | [notes] |
| TEST-08 | Borrower data in dashboard | [PASS/FAIL] | [notes] |
| TEST-09 | Visualizations render correctly | [PASS/FAIL] | [notes] |

## Overall: [X/4 PASS]

## Detailed Results

### TEST-06: Source Attribution UI
[User observations from checkpoint Task 2]

### TEST-07: Character-Level Offsets
[User observations from checkpoint Task 3]

### TEST-08: Dashboard Data
[User observations from checkpoint Task 2]

### TEST-09: Visualizations
[User observations from checkpoint Task 3]

## Production URLs Tested
- Frontend: https://loan-frontend-prod-fjz2snvxjq-uc.a.run.app
- Backend: https://loan-backend-prod-fjz2snvxjq-uc.a.run.app

## Phase 21 Complete
v2.1 Production Deployment & Verification milestone [COMPLETE/INCOMPLETE]
```

If all tests pass, Phase 21 and v2.1 milestone are complete.
If any tests fail, document gaps for potential follow-up.
  </action>
  <verify>
```bash
cat /Users/gregorydickson/stackpoint/loan/.planning/phases/21-ui-feature-verification/21-02-VERIFICATION.md
```
Verify report contains results for all four tests.
  </verify>
  <done>
- Verification report created with all test results
- Phase 21 status determined (complete or gaps identified)
  </done>
</task>

</tasks>

<verification>
Phase 21 verification is complete when:

1. All four tests have documented status (PASS/FAIL/PARTIAL)
2. Verification report exists at `.planning/phases/21-ui-feature-verification/21-02-VERIFICATION.md`
3. Any failures have been documented with clear gap description

Final API verification:
```bash
BACKEND_URL="https://loan-backend-prod-fjz2snvxjq-uc.a.run.app"
curl -s "$BACKEND_URL/health"
# Should return: {"status":"healthy"}
```
</verification>

<success_criteria>
- [ ] TEST-06: Source attribution UI shows page references - VERIFIED
- [ ] TEST-07: Character-level offsets display for LangExtract - VERIFIED
- [ ] TEST-08: Borrower data appears in dashboard - VERIFIED
- [ ] TEST-09: Extraction visualizations render correctly - VERIFIED
- [ ] Verification report created documenting all results
- [ ] v2.1 milestone status determined
</success_criteria>

<output>
After completion, create `.planning/phases/21-ui-feature-verification/21-02-SUMMARY.md`

Update `.planning/STATE.md` to reflect Phase 21 completion.

If all v2.1 tests pass, update `.planning/ROADMAP.md` to mark v2.1 as complete.
</output>
