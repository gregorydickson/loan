---
phase: 08-wire-document-to-extraction-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/api/dependencies.py
  - backend/src/ingestion/document_service.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BorrowerExtractor is instantiated with all required components"
    - "DocumentService receives BorrowerExtractor and BorrowerRepository via DI"
    - "FastAPI dependency chain resolves correctly at startup"
  artifacts:
    - path: "backend/src/api/dependencies.py"
      provides: "get_borrower_extractor factory and updated get_document_service"
      exports: ["get_borrower_extractor", "BorrowerExtractorDep"]
    - path: "backend/src/ingestion/document_service.py"
      provides: "DocumentService constructor accepting extraction dependencies"
      contains: "borrower_extractor: BorrowerExtractor"
  key_links:
    - from: "backend/src/api/dependencies.py"
      to: "backend/src/extraction/__init__.py"
      via: "imports BorrowerExtractor and all components"
      pattern: "from src.extraction import"
    - from: "backend/src/api/dependencies.py"
      to: "backend/src/ingestion/document_service.py"
      via: "passes BorrowerExtractor to DocumentService"
      pattern: "borrower_extractor=.*extractor"
---

<objective>
Wire extraction dependencies into DocumentService via FastAPI dependency injection.

Purpose: Enable DocumentService to call BorrowerExtractor by providing it through the existing DI pattern. This is the first step to closing the Phase 2 -> Phase 3 integration gap.

Output: Updated dependencies.py with get_borrower_extractor() factory and DocumentService accepting extraction dependencies.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-wire-document-to-extraction-pipeline/08-RESEARCH.md

# Key files to understand existing patterns
@backend/src/api/dependencies.py
@backend/src/ingestion/document_service.py
@backend/src/extraction/__init__.py
@backend/src/extraction/extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BorrowerExtractor DI factory to dependencies.py</name>
  <files>backend/src/api/dependencies.py</files>
  <action>
Add get_borrower_extractor() factory function following the existing singleton pattern (like get_gcs_client, get_docling_processor).

Implementation details:
1. Add imports at top of file:
   ```python
   from src.extraction import (
       BorrowerExtractor,
       GeminiClient,
       ComplexityClassifier,
       DocumentChunker,
       FieldValidator,
       ConfidenceCalculator,
       BorrowerDeduplicator,
       ConsistencyValidator,
   )
   ```

2. Add singleton pattern for BorrowerExtractor:
   ```python
   _borrower_extractor: BorrowerExtractor | None = None

   def get_borrower_extractor() -> BorrowerExtractor:
       """Get or create BorrowerExtractor singleton with all components.

       Returns:
           BorrowerExtractor instance configured with:
           - GeminiClient for LLM extraction
           - ComplexityClassifier for model routing
           - DocumentChunker for large documents
           - FieldValidator for format validation
           - ConfidenceCalculator for scoring
           - BorrowerDeduplicator for merging duplicates
           - ConsistencyValidator for data quality checks
       """
       global _borrower_extractor

       if _borrower_extractor is None:
           _borrower_extractor = BorrowerExtractor(
               llm_client=GeminiClient(),
               classifier=ComplexityClassifier(),
               chunker=DocumentChunker(),
               validator=FieldValidator(),
               confidence_calc=ConfidenceCalculator(),
               deduplicator=BorrowerDeduplicator(),
               consistency_validator=ConsistencyValidator(),
           )

       return _borrower_extractor

   BorrowerExtractorDep = Annotated[BorrowerExtractor, Depends(get_borrower_extractor)]
   ```

3. Update __all__ to export new symbols:
   - Add "BorrowerExtractorDep" to __all__ list

IMPORTANT: Do NOT modify get_document_service yet - that's Task 2.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.dependencies import get_borrower_extractor, BorrowerExtractorDep; print('Import successful')"`
Expected: "Import successful" with no errors
  </verify>
  <done>
- get_borrower_extractor() factory exists and returns BorrowerExtractor
- BorrowerExtractorDep type alias exported
- Import test passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DocumentService to accept extraction dependencies</name>
  <files>backend/src/ingestion/document_service.py, backend/src/api/dependencies.py</files>
  <action>
Update DocumentService constructor to accept BorrowerExtractor and BorrowerRepository, and update get_document_service() to wire them.

1. In document_service.py, update imports at top:
   ```python
   from src.extraction import BorrowerExtractor
   from src.storage.repositories import BorrowerRepository, DocumentRepository
   ```

2. Update DocumentService.__init__ signature and docstring:
   ```python
   def __init__(
       self,
       repository: DocumentRepository,
       gcs_client: GCSClient,
       docling_processor: DoclingProcessor,
       borrower_extractor: BorrowerExtractor,
       borrower_repository: BorrowerRepository,
   ) -> None:
       """Initialize DocumentService.

       Args:
           repository: DocumentRepository for document database operations
           gcs_client: GCSClient for file storage
           docling_processor: DoclingProcessor for document processing
           borrower_extractor: BorrowerExtractor for LLM-based extraction
           borrower_repository: BorrowerRepository for persisting borrowers
       """
       self.repository = repository
       self.gcs_client = gcs_client
       self.docling_processor = docling_processor
       self.borrower_extractor = borrower_extractor
       self.borrower_repository = borrower_repository
   ```

3. In dependencies.py, update get_document_service():
   ```python
   def get_document_service(
       repository: DocumentRepoDep,
       gcs_client: GCSClientDep,
       docling_processor: DoclingProcessorDep,
       borrower_extractor: BorrowerExtractorDep,
       borrower_repository: BorrowerRepoDep,
   ) -> DocumentService:
       """Get document service with all dependencies."""
       return DocumentService(
           repository=repository,
           gcs_client=gcs_client,
           docling_processor=docling_processor,
           borrower_extractor=borrower_extractor,
           borrower_repository=borrower_repository,
       )
   ```

NOTE: The upload() method still does NOT call the extractor yet - that integration is Plan 02. This task only wires the dependencies.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.dependencies import get_document_service; print('DI chain resolves')"`
AND
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -m pytest tests/integration/test_e2e_flow.py::test_upload_to_extraction_flow -v --tb=short 2>&1 | head -30`
Expected: Import succeeds AND existing test still passes (since upload() behavior unchanged)
  </verify>
  <done>
- DocumentService constructor accepts borrower_extractor and borrower_repository
- get_document_service() passes all dependencies
- Existing integration tests pass (no behavior change yet)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update integration test fixtures for new dependencies</name>
  <files>backend/tests/integration/conftest.py</files>
  <action>
Update integration test fixtures to mock BorrowerExtractor, ensuring existing tests continue to pass.

1. Add mock_borrower_extractor fixture:
   ```python
   @pytest.fixture
   def mock_borrower_extractor():
       """Create mock BorrowerExtractor that returns empty results."""
       from src.extraction import BorrowerExtractor, ExtractionResult
       from src.extraction.complexity_classifier import ComplexityAssessment, ComplexityLevel

       extractor = MagicMock(spec=BorrowerExtractor)
       extractor.extract = MagicMock(
           return_value=ExtractionResult(
               borrowers=[],
               complexity=ComplexityAssessment(
                   level=ComplexityLevel.SIMPLE,
                   reasons=["Test document"],
                   page_count=1,
                   indicator_counts={},
               ),
               chunks_processed=1,
               total_tokens=100,
               validation_errors=[],
               consistency_warnings=[],
           )
       )
       return extractor
   ```

2. Add import for get_borrower_extractor at top:
   ```python
   from src.api.dependencies import get_docling_processor, get_gcs_client, get_borrower_extractor
   ```

3. Update client fixture to include mock_borrower_extractor:
   - Add mock_borrower_extractor parameter
   - Add override for get_borrower_extractor:
     ```python
     def override_get_borrower_extractor():
         return mock_borrower_extractor

     app.dependency_overrides[get_borrower_extractor] = override_get_borrower_extractor
     ```

4. Similarly update client_with_failing_gcs and client_with_failing_docling fixtures.

IMPORTANT: Tests should continue to pass because upload() doesn't call extractor yet.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -m pytest tests/integration/test_e2e_flow.py -v --tb=short`
Expected: All tests pass
  </verify>
  <done>
- mock_borrower_extractor fixture exists
- All client fixtures override get_borrower_extractor
- All integration tests pass
  </done>
</task>

</tasks>

<verification>
All verification steps:
1. `python -c "from src.api.dependencies import get_borrower_extractor, BorrowerExtractorDep"` - imports work
2. `python -c "from src.api.dependencies import get_document_service"` - DI chain resolves
3. `pytest tests/integration/test_e2e_flow.py -v` - all tests pass
4. `pytest tests/integration/test_documents_api.py -v` - all document API tests pass
</verification>

<success_criteria>
- BorrowerExtractor DI factory implemented with singleton pattern
- DocumentService accepts extraction dependencies via constructor
- get_document_service() wires all 5 dependencies
- Integration test fixtures updated with mock extractor
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/08-wire-document-to-extraction-pipeline/08-01-SUMMARY.md`
</output>
