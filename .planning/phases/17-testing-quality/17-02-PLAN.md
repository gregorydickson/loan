---
phase: 17-testing-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/unit/extraction/test_few_shot_examples.py
  - backend/tests/integration/test_e2e_langextract.py
  - backend/tests/integration/conftest.py
autonomous: true

must_haves:
  truths:
    - "Few-shot examples have verbatim extraction_text validated by tests"
    - "E2E test exists for LangExtract extraction path"
    - "LangExtract path produces borrowers with character offsets"
  artifacts:
    - path: "backend/tests/unit/extraction/test_few_shot_examples.py"
      provides: "Few-shot example validation tests"
      exports: ["TestFewShotExampleValidation"]
    - path: "backend/tests/integration/test_e2e_langextract.py"
      provides: "E2E tests for LangExtract extraction path"
      exports: ["TestLangExtractE2E"]
  key_links:
    - from: "backend/tests/unit/extraction/test_few_shot_examples.py"
      to: "backend/examples/__init__.py"
      via: "validate_examples function"
      pattern: "validate_examples"
    - from: "backend/tests/integration/test_e2e_langextract.py"
      to: "backend/src/extraction/langextract_processor.py"
      via: "mocked extraction"
      pattern: "LangExtractProcessor"
---

<objective>
Add few-shot example validation tests and E2E tests for LangExtract extraction path

Purpose: TEST-01 requires few-shot example validation and TEST-06 requires E2E tests for the LangExtract extraction path. These tests ensure the dual pipeline is properly tested end-to-end.

Output:
- New test file for few-shot example validation
- New E2E integration test for LangExtract path
- Both Docling and LangExtract paths have E2E test coverage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/examples/__init__.py
@backend/tests/integration/test_e2e_extraction.py
@backend/tests/integration/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create few-shot example validation tests</name>
  <files>backend/tests/unit/extraction/test_few_shot_examples.py</files>
  <action>
Create comprehensive tests for few-shot example validation (TEST-01).

Create `backend/tests/unit/extraction/test_few_shot_examples.py` following existing test patterns in the codebase.

The test file should:
1. Import from `examples` module (ALL_EXAMPLES, BORROWER_EXAMPLES, INCOME_EXAMPLES, ACCOUNT_EXAMPLES, validate_examples)
2. Create TestFewShotExampleValidation class with tests:
   - test_validate_examples_returns_no_errors: Call validate_examples(), assert no errors
   - test_borrower_examples_exist: Assert >= 3 borrower examples
   - test_income_examples_exist: Assert >= 3 income examples
   - test_account_examples_exist: Assert >= 3 account examples
   - test_all_examples_combined: Assert ALL_EXAMPLES contains sum of all categories
   - test_extraction_text_is_verbatim_substring: For each example, verify extraction_text is exact substring of example.text

3. Create TestFewShotExampleCompleteness class verifying extraction classes are present
4. Create TestFewShotExampleQuality class for production quality checks (diverse lengths, no duplicates, non-empty extraction_text)

Reference existing test files in `backend/tests/unit/extraction/` for import patterns and pytest conventions.
  </action>
  <verify>
```bash
cd backend && python3 -m pytest tests/unit/extraction/test_few_shot_examples.py -v 2>&1 | grep -E "passed|failed|PASSED|FAILED"
```
All tests should pass.
  </verify>
  <done>All few-shot example validation tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E test for LangExtract extraction path</name>
  <files>
backend/tests/integration/test_e2e_langextract.py
backend/tests/integration/conftest.py
  </files>
  <action>
Create E2E integration test for LangExtract extraction path (TEST-06).

**Step 1:** Add mock_langextract_processor fixture to `backend/tests/integration/conftest.py` if not present. The fixture should:
- Mock LangExtractProcessor
- Return a LangExtractResult with BorrowerRecord containing SourceReference with char_start/char_end populated
- Include standard mock data (name, ssn, address, income)

**Step 2:** Create `backend/tests/integration/test_e2e_langextract.py` with:
- test_langextract_path_produces_char_offsets: Upload document with method=langextract, verify SourceReference has char offsets (TEST-06, DUAL-08)
- test_langextract_extraction_method_recorded: Verify method parameter is accepted
- test_docling_default_method_still_works: Regression test for Docling path (TEST-05, DUAL-09)
- test_method_auto_accepted: Verify auto method is accepted

Use @pytest.mark.integration and @pytest.mark.asyncio decorators. Reference existing patterns in test_e2e_extraction.py.
  </action>
  <verify>
```bash
cd backend && python3 -m pytest tests/integration/test_e2e_langextract.py -v 2>&1 | grep -E "passed|failed|PASSED|FAILED"
```
Tests should pass (may need to adapt based on actual API behavior).
  </verify>
  <done>E2E LangExtract tests exist and pass</done>
</task>

</tasks>

<verification>
Run new test files:

```bash
cd backend && python3 -m pytest tests/unit/extraction/test_few_shot_examples.py tests/integration/test_e2e_langextract.py -v
```

All tests should pass.
</verification>

<success_criteria>
- [ ] test_few_shot_examples.py created with validation tests
- [ ] All few-shot validation tests pass
- [ ] test_e2e_langextract.py created with E2E tests
- [ ] LangExtract E2E tests pass
- [ ] TEST-01 (few-shot validation) requirement satisfied
- [ ] TEST-06 (E2E LangExtract) requirement satisfied
- [ ] TEST-05 (E2E Docling regression) verified
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-quality/17-02-SUMMARY.md`
</output>
