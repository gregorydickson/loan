---
phase: 17-testing-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/unit/test_document_service.py
  - backend/src/extraction/offset_translator.py
  - backend/src/extraction/langextract_processor.py
  - backend/src/ocr/lightonocr_client.py
  - backend/src/ocr/ocr_router.py
  - backend/src/ingestion/document_service.py
  - backend/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "All unit tests pass without failures"
    - "mypy strict mode passes with no errors"
    - "Test coverage remains above 80%"
  artifacts:
    - path: "backend/tests/unit/test_document_service.py"
      provides: "Fixed DocumentService tests with updated constructor signature"
      contains: "borrower_extractor"
    - path: "backend/src/extraction/offset_translator.py"
      provides: "Type-safe offset translator"
      contains: "Sequence"
    - path: "backend/pyproject.toml"
      provides: "mypy ignore configuration for untyped libraries"
      contains: "ignore_missing_imports"
  key_links:
    - from: "backend/tests/unit/test_document_service.py"
      to: "backend/src/ingestion/document_service.py"
      via: "DocumentService constructor"
      pattern: "DocumentService\\("
---

<objective>
Fix broken tests and resolve mypy strict mode errors to establish a passing baseline

Purpose: The test suite has 15 failing tests due to DocumentService constructor changes from v2.0 work, and mypy strict mode reports 14 errors. This plan fixes these issues to establish a green baseline before adding new tests.

Output:
- All 15 failing tests in test_document_service.py fixed
- All 14 mypy errors resolved
- Test suite passes with >80% coverage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/tests/unit/test_document_service.py
@backend/src/ingestion/document_service.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix test_document_service.py constructor calls</name>
  <files>backend/tests/unit/test_document_service.py</files>
  <action>
Update DocumentService instantiation in test fixtures to include the new required arguments:

1. Read the current DocumentService constructor signature from `src/ingestion/document_service.py`
2. Update the fixture that creates DocumentService to include:
   - `borrower_extractor` - mock BorrowerExtractor
   - `borrower_repository` - mock BorrowerRepository
3. Add appropriate mock fixtures for:
   - `mock_borrower_extractor` returning MagicMock(spec=BorrowerExtractor)
   - `mock_borrower_repository` returning MagicMock(spec=BorrowerRepository)
4. Update all test class fixtures that instantiate DocumentService

Follow existing patterns from test_dual_pipeline.py for mocking extraction components.

Do NOT change any test logic - only fix the constructor arguments.
  </action>
  <verify>
```bash
cd backend && python3 -m pytest tests/unit/test_document_service.py -v --tb=short 2>&1 | grep -E "passed|failed|error"
```
All 15+ tests should pass.
  </verify>
  <done>All tests in test_document_service.py pass (0 failures)</done>
</task>

<task type="auto">
  <name>Task 2: Fix mypy errors in source files</name>
  <files>
backend/src/extraction/offset_translator.py
backend/src/extraction/langextract_processor.py
backend/src/ocr/lightonocr_client.py
backend/src/ocr/ocr_router.py
backend/src/ingestion/document_service.py
backend/pyproject.toml
  </files>
  <action>
Fix all 14 mypy errors. The errors fall into these categories:

**1. Missing type stubs (pypdfium2, aiobreaker) - pyproject.toml:**
Add module-specific overrides to pyproject.toml:
```toml
[[tool.mypy.overrides]]
module = ["pypdfium2", "aiobreaker"]
ignore_missing_imports = true
```

**2. offset_translator.py line 46 - Type mismatch:**
Change from `list[Match]` to use proper typing:
```python
from typing import Sequence
# Change variable type annotation to match actual return
matches: list[tuple[int, int, int]] = ...
```
Or use the actual Match type from re module properly.

**3. lightonocr_client.py lines 65, 170 - Returning Any:**
Add explicit cast or type annotation:
```python
from typing import cast
token: str = cast(str, id_token.fetch_id_token(request, audience))
```

**4. ocr_router.py line 110 - Untyped decorator:**
Add type annotation to the decorated function or use `# type: ignore[misc]` with comment explaining aiobreaker lacks type stubs.

**5. ocr_router.py line 286 - Returning Any:**
Cast the return value or add explicit type annotation.

**6. langextract_visualizer.py line 44 - Returning Any:**
Add cast or explicit type handling.

**7. langextract_processor.py lines 156, 168 - None handling:**
Add proper None checks before iteration and argument passing:
```python
if result.extractions is not None:
    for extraction in result.extractions:
        ...
```
For line 168, check char_start/char_end are not None before calling verify_offset.

**8. document_service.py line 304 - Literal type:**
Change the `mode` variable to use the OCRMode type alias:
```python
from src.ocr.ocr_router import OCRMode
mode: OCRMode = ...
```

Run mypy after each file fix to verify progress.
  </action>
  <verify>
```bash
cd backend && python3 -m mypy src/ 2>&1 | tail -5
```
Should show "Success: no issues found in 41 source files" (or similar success message).
  </verify>
  <done>mypy src/ passes with 0 errors</done>
</task>

<task type="auto">
  <name>Task 3: Verify test suite health</name>
  <files>backend/tests/</files>
  <action>
Run the complete test suite to verify:
1. All tests pass (no failures)
2. Coverage remains above 80%
3. No new warnings introduced

```bash
cd backend && python3 -m pytest --cov=src --cov-report=term-missing -q
```

If any tests fail that weren't failing before, investigate and fix. The goal is a completely green test suite.

Document the final test count and coverage percentage.
  </action>
  <verify>
```bash
cd backend && python3 -m pytest --cov=src --cov-fail-under=80 -q 2>&1 | tail -10
```
Should show all tests passed and coverage >= 80%.
  </verify>
  <done>pytest passes with 0 failures and coverage >= 80%</done>
</task>

</tasks>

<verification>
Run complete validation:

```bash
cd backend && python3 -m mypy src/ && python3 -m pytest --cov=src --cov-fail-under=80 -q
```

Both commands must succeed.
</verification>

<success_criteria>
- [ ] All 15 failing tests in test_document_service.py now pass
- [ ] mypy strict mode passes with 0 errors
- [ ] pytest runs with 0 failures
- [ ] Test coverage >= 80%
- [ ] TEST-11 (coverage) requirement satisfied
- [ ] TEST-12 (mypy strict) requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/17-testing-quality/17-01-SUMMARY.md`
</output>
