---
phase: 16-cloudbuild-deployment
plan: 03
type: execute
wave: 2
depends_on:
  - "16-01"
files_modified:
  - infrastructure/scripts/setup-github-triggers.sh
  - docs/cloudbuild-deployment-guide.md
autonomous: false

must_haves:
  truths:
    - "GitHub triggers can be created for all three services"
    - "Triggers are scoped to relevant files (--included-files)"
    - "Deployment guide documents complete CI/CD workflow"
  artifacts:
    - path: "infrastructure/scripts/setup-github-triggers.sh"
      provides: "GitHub trigger creation script"
      contains: "gcloud builds triggers create github"
    - path: "docs/cloudbuild-deployment-guide.md"
      provides: "Complete deployment documentation"
      contains: "Multi-Service Orchestration"
  key_links:
    - from: "setup-github-triggers.sh"
      to: "cloudbuild.yaml files"
      via: "--build-config parameter"
      pattern: "build-config=infrastructure/cloudbuild"
    - from: "deployment-guide"
      to: "rollback.sh"
      via: "documentation reference"
      pattern: "rollback.sh"
---

<objective>
Create GitHub trigger setup script and comprehensive deployment guide.

Purpose: Enable automatic builds on push to main via GitHub triggers and provide complete documentation for the CloudBuild deployment workflow. This satisfies CBLD-07 (GitHub triggers), CBLD-10 (multi-service orchestration), and completes CBLD-11 (rollback documentation).

Output:
- infrastructure/scripts/setup-github-triggers.sh (CBLD-07)
- docs/cloudbuild-deployment-guide.md (CBLD-10, CBLD-11)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cloudbuild-deployment/16-CONTEXT.md
@.planning/phases/16-cloudbuild-deployment/16-RESEARCH.md
@.planning/phases/16-cloudbuild-deployment/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub trigger setup script</name>
  <files>infrastructure/scripts/setup-github-triggers.sh</files>
  <action>
Create script to create GitHub triggers for all three services.

**Prerequisites documented in header:**
- GitHub repository connected to Cloud Build via Developer Connect (Console setup required)
- Connection name known (user must provide or discover)
- cloudbuild-deployer service account exists (from Phase 10)

**Script structure:**
- Shebang, set -euo pipefail
- Accept PROJECT_ID as required arg
- Accept CONNECTION_NAME as required arg (GitHub connection name from Console)
- REGION env var or default us-central1
- REPO_NAME env var or default "loan"

**Three triggers to create:**

1. **backend-deploy:**
   - Branch pattern: `^main$`
   - Build config: `infrastructure/cloudbuild/backend-cloudbuild.yaml`
   - Included files: `backend/**,infrastructure/cloudbuild/backend-cloudbuild.yaml`
   - Service account: cloudbuild-deployer

2. **frontend-deploy:**
   - Branch pattern: `^main$`
   - Build config: `infrastructure/cloudbuild/frontend-cloudbuild.yaml`
   - Included files: `frontend/**,infrastructure/cloudbuild/frontend-cloudbuild.yaml`
   - Service account: cloudbuild-deployer
   - Substitution override: `_BACKEND_URL=https://loan-backend-prod-xxx.run.app` (placeholder in script, user updates)

3. **gpu-deploy:**
   - Branch pattern: `^main$`
   - Build config: `infrastructure/cloudbuild/gpu-cloudbuild.yaml`
   - Included files: `infrastructure/lightonocr-gpu/**,infrastructure/cloudbuild/gpu-cloudbuild.yaml`
   - Service account: cloudbuild-deployer

**Command pattern:**
```bash
gcloud builds triggers create github \
    --name="backend-deploy" \
    --region="${REGION}" \
    --repository="projects/${PROJECT_ID}/locations/${REGION}/connections/${CONNECTION_NAME}/repositories/${REPO_NAME}" \
    --branch-pattern="^main$" \
    --build-config="infrastructure/cloudbuild/backend-cloudbuild.yaml" \
    --service-account="projects/${PROJECT_ID}/serviceAccounts/cloudbuild-deployer@${PROJECT_ID}.iam.gserviceaccount.com" \
    --included-files="backend/**,infrastructure/cloudbuild/backend-cloudbuild.yaml"
```

**Output:** List created triggers and next steps
  </action>
  <verify>
Script passes bash syntax check: `bash -n infrastructure/scripts/setup-github-triggers.sh`
  </verify>
  <done>setup-github-triggers.sh exists with triggers for all three services using --included-files scoping</done>
</task>

<task type="auto">
  <name>Task 2: Create CloudBuild deployment guide</name>
  <files>docs/cloudbuild-deployment-guide.md</files>
  <action>
Create comprehensive deployment guide covering:

**1. Overview**
- CloudBuild replaces Terraform for application deployments
- One-time infrastructure via gcloud CLI (provision-infra.sh)
- Repeating deploys via CloudBuild triggers
- Link to terraform-to-gcloud-inventory.md

**2. Prerequisites**
- GCP project with billing enabled
- gcloud CLI installed and authenticated
- GitHub repository connected via Developer Connect (link to Console instructions)

**3. One-Time Setup**
- Run setup-gcp.sh for APIs and Artifact Registry
- Run setup-service-account.sh for CloudBuild SA
- Run provision-infra.sh for VPC, Cloud SQL, Cloud Tasks
- Create secrets in Secret Manager (DATABASE_URL, GEMINI_API_KEY)
- Connect GitHub repository in Cloud Build Console
- Run setup-github-triggers.sh with connection name

**4. Automated Deployments**
- Push to main triggers builds
- Each service has independent trigger with file scoping
- Build status visible in GitHub commit status
- Logs in Cloud Build Console

**5. Manual Deployments**
- Run cloudbuild.yaml directly: `gcloud builds submit --config=...`
- Useful for emergency fixes or testing

**6. Multi-Service Orchestration (CBLD-10)**
- Services deploy independently (no orchestration layer)
- Parallel builds acceptable
- Services handle unavailability gracefully
- Order doesn't matter for this POC

**7. Rollback Procedures (CBLD-11)**
- Use rollback.sh for quick rollback
- List revisions: `./rollback.sh SERVICE`
- Rollback to specific revision: `./rollback.sh SERVICE REVISION`
- Verify with `gcloud run services describe`

**8. Troubleshooting**
- Common errors: Permission denied, VPC connectivity, Secret access
- How to check build logs
- How to verify service health
  </action>
  <verify>
File exists and contains expected sections: `grep -q "Multi-Service Orchestration" docs/cloudbuild-deployment-guide.md`
  </verify>
  <done>cloudbuild-deployment-guide.md provides complete CI/CD workflow documentation including rollback procedures</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
CloudBuild deployment infrastructure:
- 3 cloudbuild.yaml files (backend, frontend, GPU)
- provision-infra.sh for one-time infrastructure
- rollback.sh for service rollback
- setup-github-triggers.sh for GitHub trigger creation
- terraform-to-gcloud-inventory.md resource mapping
- cloudbuild-deployment-guide.md comprehensive guide
  </what-built>
  <how-to-verify>
1. Review cloudbuild.yaml files:
   - `cat infrastructure/cloudbuild/backend-cloudbuild.yaml`
   - `cat infrastructure/cloudbuild/frontend-cloudbuild.yaml`
   - `cat infrastructure/cloudbuild/gpu-cloudbuild.yaml`
   - Verify Secret Manager integration in backend config
   - Verify GPU flags in gpu config

2. Review scripts:
   - `cat infrastructure/scripts/provision-infra.sh`
   - `cat infrastructure/scripts/rollback.sh`
   - `cat infrastructure/scripts/setup-github-triggers.sh`

3. Review documentation:
   - `cat docs/terraform-to-gcloud-inventory.md`
   - `cat docs/cloudbuild-deployment-guide.md`

4. Optional: If you want to test actual deployment:
   - Connect GitHub repo in Cloud Build Console first
   - Run: `./infrastructure/scripts/setup-github-triggers.sh PROJECT_ID CONNECTION_NAME`
   - Push a change to main and observe build trigger

Note: Actual GitHub connection requires Console UI (one-time manual setup).
  </how-to-verify>
  <resume-signal>Type "approved" if configuration looks correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. setup-github-triggers.sh creates triggers with correct --included-files scoping
2. cloudbuild-deployment-guide.md documents complete workflow
3. All scripts pass bash syntax validation
4. Documentation references all created artifacts (cloudbuild.yaml, scripts)
</verification>

<success_criteria>
- GitHub trigger script created for all three services
- Triggers use --included-files to scope builds to relevant changes
- Deployment guide covers one-time setup, automated deploys, manual deploys, orchestration, and rollback
- User has verified the complete CloudBuild deployment configuration
</success_criteria>

<output>
After completion, create `.planning/phases/16-cloudbuild-deployment/16-03-SUMMARY.md`
</output>
