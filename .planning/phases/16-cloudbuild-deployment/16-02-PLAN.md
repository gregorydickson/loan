---
phase: 16-cloudbuild-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/scripts/provision-infra.sh
  - infrastructure/scripts/rollback.sh
  - docs/terraform-to-gcloud-inventory.md
autonomous: true

must_haves:
  truths:
    - "Terraform resources are documented with gcloud CLI equivalents"
    - "One-time infrastructure can be provisioned via gcloud CLI"
    - "Cloud Run services can be rolled back to previous revisions"
  artifacts:
    - path: "docs/terraform-to-gcloud-inventory.md"
      provides: "Terraform to gcloud mapping documentation"
      contains: "google_cloud_run_v2_service"
    - path: "infrastructure/scripts/provision-infra.sh"
      provides: "One-time infrastructure provisioning"
      contains: "gcloud sql instances create"
    - path: "infrastructure/scripts/rollback.sh"
      provides: "Rollback helper for Cloud Run"
      contains: "gcloud run services update-traffic"
  key_links:
    - from: "provision-infra.sh"
      to: "GCP Infrastructure"
      via: "gcloud CLI commands"
      pattern: "gcloud (compute|sql|tasks)"
    - from: "rollback.sh"
      to: "Cloud Run"
      via: "traffic management"
      pattern: "update-traffic.*to-revisions"
---

<objective>
Create infrastructure provisioning scripts and rollback procedures.

Purpose: Provide gcloud CLI alternatives to Terraform for one-time infrastructure setup and documented rollback procedures for deployment failures. This satisfies CBLD-05 (Terraform inventory), CBLD-06 (one-time scripts), and CBLD-11 (rollback procedures).

Output:
- docs/terraform-to-gcloud-inventory.md (CBLD-05)
- infrastructure/scripts/provision-infra.sh (CBLD-06)
- infrastructure/scripts/rollback.sh (CBLD-11)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cloudbuild-deployment/16-CONTEXT.md
@.planning/phases/16-cloudbuild-deployment/16-RESEARCH.md

# Existing infrastructure
@infrastructure/scripts/setup-gcp.sh
@infrastructure/cloudbuild/setup-service-account.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Terraform to gcloud inventory documentation</name>
  <files>docs/terraform-to-gcloud-inventory.md</files>
  <action>
Create documentation mapping Terraform-managed resources to gcloud CLI equivalents.

**Document structure:**

1. **Overview**: Explain migration from Terraform to CloudBuild + gcloud CLI
2. **One-time resources** (provisioned once, rarely changed):
   - VPC network: `google_compute_network` -> `gcloud compute networks create`
   - Subnet: `google_compute_subnetwork` -> `gcloud compute networks subnets create`
   - Private IP allocation: `google_compute_global_address` -> `gcloud compute addresses create --global`
   - VPC peering: `google_service_networking_connection` -> `gcloud services vpc-peerings connect`
   - Cloud SQL: `google_sql_database_instance` -> `gcloud sql instances create`
   - Database: `google_sql_database` -> `gcloud sql databases create`
   - Cloud Tasks queue: `google_cloud_tasks_queue` -> `gcloud tasks queues create`
   - Storage bucket: `google_storage_bucket` -> `gcloud storage buckets create`
   - Secrets: `google_secret_manager_secret` -> `gcloud secrets create`
   - Service accounts: `google_service_account` -> `gcloud iam service-accounts create`
   - IAM bindings: `google_project_iam_member` -> `gcloud projects add-iam-policy-binding`

3. **Repeating resources** (managed by CloudBuild):
   - Cloud Run services: `google_cloud_run_v2_service` -> `gcloud run deploy` (via CloudBuild)

4. **Script references**: Point to provision-infra.sh for one-time setup

Include a table with columns: Terraform Resource | gcloud Equivalent | One-Time/Repeating | Script Location
  </action>
  <verify>
File exists and contains expected sections: `grep -q "google_cloud_run_v2_service" docs/terraform-to-gcloud-inventory.md`
  </verify>
  <done>Terraform inventory documentation exists with complete resource mapping and migration guidance</done>
</task>

<task type="auto">
  <name>Task 2: Create infrastructure provisioning script</name>
  <files>infrastructure/scripts/provision-infra.sh</files>
  <action>
Create one-time gcloud CLI infrastructure provisioning script.

**Script structure:**
- Shebang, set -euo pipefail
- Accept PROJECT_ID as required arg, REGION optional (default us-central1)
- All commands idempotent (use `2>/dev/null || echo "already exists"` pattern)

**Commands to include (based on 16-RESEARCH.md Pattern):**

1. Enable required APIs:
   - compute, run, sqladmin, secretmanager, cloudtasks
   - servicenetworking, artifactregistry, cloudbuild

2. Create VPC network:
   - Name: `${PROJECT_ID}-vpc`
   - Subnet mode: custom

3. Create Cloud Run subnet:
   - Name: `cloud-run-subnet`
   - Region: ${REGION}
   - Range: 10.0.0.0/24
   - Enable private IP Google access

4. Allocate private IP range for VPC peering:
   - Name: `private-ip-address`
   - Global, VPC_PEERING purpose
   - Range: 10.1.0.0/16

5. Create VPC peering for Cloud SQL:
   - Connect servicenetworking.googleapis.com

6. Create Cloud SQL instance:
   - Name: `loan-db-prod`
   - Postgres 16, db-f1-micro tier
   - Private IP only (--no-assign-ip, --network)
   - SSD storage, 10GB

7. Create database:
   - Name: `loan_extraction`

8. Create Cloud Tasks queue:
   - Name: `document-processing`
   - Max dispatches: 10/s, max concurrent: 5
   - Max attempts: 5, backoff: 10s-3600s

**Output:** Summary of what was created and next steps
  </action>
  <verify>
Script is executable and passes bash syntax check: `bash -n infrastructure/scripts/provision-infra.sh`
  </verify>
  <done>provision-infra.sh exists with idempotent gcloud commands for VPC, Cloud SQL, and Cloud Tasks</done>
</task>

<task type="auto">
  <name>Task 3: Create rollback helper script</name>
  <files>infrastructure/scripts/rollback.sh</files>
  <action>
Create Cloud Run rollback helper script.

**Script features:**
- Accept SERVICE name as required arg
- Accept optional REVISION to rollback to
- If no revision provided, list recent 5 revisions and prompt
- Use REGION env var or default to us-central1

**Commands:**

1. List revisions (if no target provided):
   ```
   gcloud run revisions list --service="$SERVICE" --region="$REGION" --limit=5 --format="table(name,active,created)"
   ```

2. Rollback command:
   ```
   gcloud run services update-traffic "$SERVICE" \
       --region="$REGION" \
       --to-revisions="${REVISION}=100"
   ```

3. Verification:
   ```
   gcloud run services describe "$SERVICE" --region="$REGION" --format="value(status.traffic)"
   ```

**Usage examples in header:**
- `./rollback.sh loan-backend-prod`
- `./rollback.sh loan-backend-prod loan-backend-prod-00042-abc`
- `REGION=us-west1 ./rollback.sh loan-frontend-prod`
  </action>
  <verify>
Script is executable and passes bash syntax check: `bash -n infrastructure/scripts/rollback.sh`
  </verify>
  <done>rollback.sh exists with revision listing and traffic shifting commands</done>
</task>

</tasks>

<verification>
1. docs/terraform-to-gcloud-inventory.md contains comprehensive resource mapping
2. provision-infra.sh passes bash syntax check and is executable
3. rollback.sh passes bash syntax check and is executable
4. All scripts use idempotent patterns (can be re-run safely)
</verification>

<success_criteria>
- Terraform resource inventory documented with gcloud equivalents
- provision-infra.sh can create VPC, Cloud SQL, Cloud Tasks from scratch
- rollback.sh provides quick rollback capability for any Cloud Run service
- All bash scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/16-cloudbuild-deployment/16-02-SUMMARY.md`
</output>
