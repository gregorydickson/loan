---
phase: 16-cloudbuild-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/cloudbuild/backend-cloudbuild.yaml
  - infrastructure/cloudbuild/frontend-cloudbuild.yaml
  - infrastructure/cloudbuild/gpu-cloudbuild.yaml
autonomous: true

must_haves:
  truths:
    - "Backend service can be built and deployed via CloudBuild"
    - "Frontend service can be built and deployed via CloudBuild"
    - "GPU service can be built and deployed via CloudBuild with L4 GPU"
    - "All services use Secret Manager for sensitive configuration"
  artifacts:
    - path: "infrastructure/cloudbuild/backend-cloudbuild.yaml"
      provides: "Backend build and deploy configuration"
      contains: "gcloud run deploy"
    - path: "infrastructure/cloudbuild/frontend-cloudbuild.yaml"
      provides: "Frontend build and deploy configuration"
      contains: "gcloud run deploy"
    - path: "infrastructure/cloudbuild/gpu-cloudbuild.yaml"
      provides: "GPU service build and deploy configuration"
      contains: "--gpu-type nvidia-l4"
  key_links:
    - from: "backend-cloudbuild.yaml"
      to: "Secret Manager"
      via: "--set-secrets flag"
      pattern: "--set-secrets"
    - from: "gpu-cloudbuild.yaml"
      to: "Cloud Run GPU"
      via: "gcloud run deploy with GPU flags"
      pattern: "--gpu 1"
---

<objective>
Create CloudBuild configuration files for all three services (backend, frontend, GPU).

Purpose: Enable automated CI/CD deployment via CloudBuild instead of manual scripts or Terraform. Each service gets its own cloudbuild.yaml for independent deployment (per CONTEXT.md decision).

Output:
- infrastructure/cloudbuild/backend-cloudbuild.yaml
- infrastructure/cloudbuild/frontend-cloudbuild.yaml
- infrastructure/cloudbuild/gpu-cloudbuild.yaml
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cloudbuild-deployment/16-CONTEXT.md
@.planning/phases/16-cloudbuild-deployment/16-RESEARCH.md

# Existing infrastructure files
@infrastructure/cloudbuild/setup-service-account.sh
@infrastructure/lightonocr-gpu/deploy.sh
@backend/Dockerfile
@frontend/Dockerfile
@infrastructure/lightonocr-gpu/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend-cloudbuild.yaml</name>
  <files>infrastructure/cloudbuild/backend-cloudbuild.yaml</files>
  <action>
Create CloudBuild configuration for backend service with:

**Build steps:**
1. Build Docker image with tags: `${SHORT_SHA}` and `latest`
2. Push to Artifact Registry `${_REGION}-docker.pkg.dev/${PROJECT_ID}/loan-repo/backend`
3. Deploy to Cloud Run `loan-backend-prod`

**Deploy configuration (from existing deploy patterns):**
- Service account: `loan-cloud-run@${PROJECT_ID}.iam.gserviceaccount.com`
- Network: `${PROJECT_ID}-vpc`, subnet: `cloud-run-subnet`
- VPC egress: `private-ranges-only` (for Cloud SQL access)
- CPU: 1, Memory: 1Gi
- Min instances: 0, Max instances: 10
- Allow unauthenticated (public API)

**Secret Manager integration:**
- DATABASE_URL from `database-url:latest`
- GEMINI_API_KEY from `gemini-api-key:latest`

**Substitutions:**
- `_REGION: us-central1`

**Options:**
- logging: CLOUD_LOGGING_ONLY
- machineType: E2_HIGHCPU_8
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('infrastructure/cloudbuild/backend-cloudbuild.yaml'))"`
  </verify>
  <done>backend-cloudbuild.yaml exists with build, push, and deploy steps including Secret Manager integration</done>
</task>

<task type="auto">
  <name>Task 2: Create frontend-cloudbuild.yaml</name>
  <files>infrastructure/cloudbuild/frontend-cloudbuild.yaml</files>
  <action>
Create CloudBuild configuration for frontend service with:

**Build steps:**
1. Build Docker image with tags: `${SHORT_SHA}` and `latest`
2. Push to Artifact Registry `${_REGION}-docker.pkg.dev/${PROJECT_ID}/loan-repo/frontend`
3. Deploy to Cloud Run `loan-frontend-prod`

**Deploy configuration:**
- CPU: 1, Memory: 512Mi
- Min instances: 0, Max instances: 5
- Allow unauthenticated (public frontend)

**Environment variables:**
- NEXT_PUBLIC_API_URL via `${_BACKEND_URL}` substitution

**Note:** NEXT_PUBLIC_* vars are baked at build time in Next.js. The `_BACKEND_URL` substitution should be set in the trigger configuration or defaulted to a known value.

**Substitutions:**
- `_REGION: us-central1`
- `_BACKEND_URL: ''` (to be set via trigger)

**Options:**
- logging: CLOUD_LOGGING_ONLY
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('infrastructure/cloudbuild/frontend-cloudbuild.yaml'))"`
  </verify>
  <done>frontend-cloudbuild.yaml exists with build, push, and deploy steps with environment variable configuration</done>
</task>

<task type="auto">
  <name>Task 3: Create gpu-cloudbuild.yaml</name>
  <files>infrastructure/cloudbuild/gpu-cloudbuild.yaml</files>
  <action>
Create CloudBuild configuration for GPU service with:

**Build steps:**
1. Build Docker image with tags: `${SHORT_SHA}` and `latest`
   - Context: `./infrastructure/lightonocr-gpu`
   - Step timeout: 3600s (model download is slow)
2. Push to Artifact Registry `${_REGION}-docker.pkg.dev/${PROJECT_ID}/loan-repo/lightonocr-gpu`
3. Deploy to Cloud Run `lightonocr-gpu`

**Deploy configuration (from existing deploy.sh):**
- Service account: `lightonocr-gpu@${PROJECT_ID}.iam.gserviceaccount.com`
- CPU: 8, Memory: 32Gi
- GPU: 1, GPU type: nvidia-l4
- Port: 8000
- Min instances: 0, Max instances: 3
- no-cpu-throttling, no-gpu-zonal-redundancy
- no-allow-unauthenticated (internal service)
- Startup probe: tcpSocket port 8000, initialDelay 240s, timeout 240s

**Substitutions:**
- `_REGION: us-central1`

**Build-level settings:**
- timeout: 4800s (80 minutes total build time)
- machineType: E2_HIGHCPU_32 (faster for large image builds)
- logging: CLOUD_LOGGING_ONLY
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('infrastructure/cloudbuild/gpu-cloudbuild.yaml'))"`
  </verify>
  <done>gpu-cloudbuild.yaml exists with build, push, deploy steps including GPU configuration and extended timeouts</done>
</task>

</tasks>

<verification>
All three cloudbuild.yaml files:
1. Pass YAML syntax validation
2. Include build, push, and deploy steps
3. Use `${PROJECT_ID}` and `${SHORT_SHA}` substitutions correctly
4. Backend includes Secret Manager `--set-secrets` flag
5. GPU includes all GPU-specific flags from existing deploy.sh
</verification>

<success_criteria>
- Three cloudbuild.yaml files created in infrastructure/cloudbuild/
- Each file defines complete build-push-deploy pipeline
- Backend uses Secret Manager for DATABASE_URL and GEMINI_API_KEY
- GPU service includes L4 GPU configuration and extended timeouts
- All files pass YAML syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/16-cloudbuild-deployment/16-01-SUMMARY.md`
</output>
