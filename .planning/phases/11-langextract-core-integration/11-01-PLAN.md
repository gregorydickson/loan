---
phase: 11-langextract-core-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/models/document.py
  - backend/src/storage/models.py
  - backend/alembic/versions/002_add_char_offsets.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SourceReference Pydantic model accepts char_start and char_end as optional integers"
    - "SourceReference ORM model has char_start and char_end nullable columns"
    - "Alembic migration adds columns without breaking existing data"
    - "Existing v1.0 code continues to work with null char offsets"
  artifacts:
    - path: "backend/src/models/document.py"
      provides: "Pydantic SourceReference with char_start/char_end"
      contains: "char_start: int | None"
    - path: "backend/src/storage/models.py"
      provides: "ORM SourceReference with char_start/char_end columns"
      contains: "char_start: Mapped[int | None]"
    - path: "backend/alembic/versions/002_add_char_offsets.py"
      provides: "Database migration for new columns"
      contains: "add_column"
  key_links:
    - from: "backend/src/models/document.py"
      to: "backend/src/storage/models.py"
      via: "matching field names for ORM conversion"
      pattern: "char_start.*char_end"
---

<objective>
Add character-level offset fields to SourceReference for LangExtract integration.

Purpose: Enable character-level source grounding by storing char_start and char_end positions in SourceReference. These fields are nullable to maintain backward compatibility with existing v1.0 Docling extractions.

Output: Updated Pydantic model, ORM model, and Alembic migration for char_start/char_end columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-langextract-core-integration/11-RESEARCH.md

@backend/src/models/document.py
@backend/src/storage/models.py
@backend/alembic/versions/001_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add char_start/char_end to Pydantic SourceReference</name>
  <files>backend/src/models/document.py</files>
  <action>
Update the SourceReference Pydantic model to add two new optional fields:

1. Add `char_start: int | None` field with:
   - Default: None
   - Field description: "Start character position in source text (inclusive), None for page-level references"
   - Constraint: ge=0 (non-negative)

2. Add `char_end: int | None` field with:
   - Default: None
   - Field description: "End character position in source text (exclusive), None for page-level references"
   - Constraint: ge=0 (non-negative)

Place these fields after `snippet` to group position-related fields together.

The fields are optional (| None with default=None) to maintain backward compatibility with existing v1.0 Docling extractions that only have page-level references.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.models.document import SourceReference; sr = SourceReference(document_id='00000000-0000-0000-0000-000000000000', document_name='test.pdf', page_number=1, snippet='test'); print(f'char_start={sr.char_start}, char_end={sr.char_end}')"`
Expected: `char_start=None, char_end=None`
  </verify>
  <done>SourceReference Pydantic model accepts char_start and char_end as optional integers with None defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add char_start/char_end to ORM SourceReference and create migration</name>
  <files>backend/src/storage/models.py, backend/alembic/versions/002_add_char_offsets.py</files>
  <action>
1. Update ORM SourceReference model in storage/models.py:
   - Add `char_start: Mapped[int | None] = mapped_column(Integer, nullable=True)`
   - Add `char_end: Mapped[int | None] = mapped_column(Integer, nullable=True)`
   - Place after `snippet` column for consistency with Pydantic model

2. Create Alembic migration in alembic/versions/002_add_char_offsets.py:
   - Revision ID: Generate a new short hash (e.g., "a1b2c3d4e5f6")
   - Down revision: Reference the 001_initial_schema.py revision ID
   - Message: "Add character offset columns to source_references"

   upgrade():
   - op.add_column("source_references", sa.Column("char_start", sa.Integer(), nullable=True))
   - op.add_column("source_references", sa.Column("char_end", sa.Integer(), nullable=True))

   downgrade():
   - op.drop_column("source_references", "char_end")
   - op.drop_column("source_references", "char_start")

Look at 001_initial_schema.py to get the correct down_revision value.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.storage.models import SourceReference; print([c.name for c in SourceReference.__table__.columns])"`
Expected: List includes 'char_start' and 'char_end'

Run: `cd /Users/gregorydickson/stackpoint/loan/backend && alembic check`
Expected: No errors about migration heads
  </verify>
  <done>ORM model has char_start/char_end nullable columns and migration file is valid</done>
</task>

</tasks>

<verification>
1. Python import test for Pydantic model:
   ```bash
   cd /Users/gregorydickson/stackpoint/loan/backend && python -c "
   from src.models.document import SourceReference
   from uuid import uuid4
   # Test with offsets
   sr1 = SourceReference(document_id=uuid4(), document_name='test.pdf', page_number=1, snippet='test', char_start=0, char_end=100)
   assert sr1.char_start == 0
   assert sr1.char_end == 100
   # Test without offsets (backward compat)
   sr2 = SourceReference(document_id=uuid4(), document_name='test.pdf', page_number=1, snippet='test')
   assert sr2.char_start is None
   assert sr2.char_end is None
   print('Pydantic model OK')
   "
   ```

2. ORM model column check:
   ```bash
   cd /Users/gregorydickson/stackpoint/loan/backend && python -c "
   from src.storage.models import SourceReference
   cols = [c.name for c in SourceReference.__table__.columns]
   assert 'char_start' in cols
   assert 'char_end' in cols
   print('ORM model OK')
   "
   ```

3. Migration file exists and is valid Alembic revision:
   ```bash
   cd /Users/gregorydickson/stackpoint/loan/backend && alembic history
   ```
</verification>

<success_criteria>
1. SourceReference Pydantic model has char_start: int | None and char_end: int | None fields with None defaults
2. SourceReference ORM model has char_start and char_end nullable Integer columns
3. Alembic migration 002_add_char_offsets.py exists with proper upgrade/downgrade functions
4. Existing code creating SourceReference without char offsets continues to work (backward compatibility)
5. Requirements LXTR-01 and LXTR-02 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-langextract-core-integration/11-01-SUMMARY.md`
</output>
