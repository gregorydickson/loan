---
phase: 07-documentation-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ARCHITECTURE_DECISIONS.md
autonomous: true

must_haves:
  truths:
    - "Each major technology choice has a documented ADR"
    - "ADRs follow consistent MADR format with Context, Decision, Consequences"
    - "Alternatives considered are documented with pros/cons"
    - "Decisions trace to actual implementation"
  artifacts:
    - path: "docs/ARCHITECTURE_DECISIONS.md"
      provides: "Architecture Decision Records for all major choices"
      min_lines: 300
      contains: ["ADR-001", "ADR-002", "ADR-003", "ADR-004", "ADR-005"]
  key_links:
    - from: "docs/ARCHITECTURE_DECISIONS.md"
      to: "Implementation files"
      via: "ADR references actual code patterns"
      pattern: "Docling|Gemini|PostgreSQL|Cloud Run|Next.js"
---

<objective>
Create Architecture Decision Records documenting all major technology choices made during the project.

Purpose: Preserve the reasoning behind architectural decisions so future maintainers understand not just what was built, but why.

Output: docs/ARCHITECTURE_DECISIONS.md containing ADRs for Docling, Gemini, PostgreSQL, Cloud Run, Next.js, and additional significant decisions from each phase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-documentation-testing/07-CONTEXT.md
@.planning/phases/07-documentation-testing/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Core Technology ADRs</name>
  <files>docs/ARCHITECTURE_DECISIONS.md</files>
  <action>
Create docs/ARCHITECTURE_DECISIONS.md with introduction and first 5 core ADRs.

**Document Structure:**
```markdown
# Architecture Decision Records

This document captures the key architectural decisions made during the development of the Loan Document Data Extraction System. Each decision follows the MADR (Markdown Any Decision Records) format.

## Index
- [ADR-001: Use Docling for Document Processing](#adr-001-use-docling-for-document-processing)
- [ADR-002: Use Gemini 3.0 with Dynamic Model Selection](#adr-002-use-gemini-30-with-dynamic-model-selection)
- [ADR-003: Use PostgreSQL for Relational Storage](#adr-003-use-postgresql-for-relational-storage)
- [ADR-004: Deploy on Cloud Run with Serverless Architecture](#adr-004-deploy-on-cloud-run-with-serverless-architecture)
- [ADR-005: Use Next.js 14 App Router for Frontend](#adr-005-use-nextjs-14-app-router-for-frontend)
...
```

**ADR Template (MADR format):**
```markdown
## ADR-NNN: [Title]

### Status
Accepted

### Context
[What is the issue that we're facing? What forces are at play?]

### Decision
[What is the change that we're actually doing?]

### Consequences
**Positive:**
- [Benefit 1]
- [Benefit 2]

**Negative:**
- [Tradeoff 1]
- [Tradeoff 2]

### Alternatives Considered
| Option | Pros | Cons |
|--------|------|------|
| [Alt 1] | [Pros] | [Cons] |
| [Alt 2] | [Pros] | [Cons] |
```

**Write these 5 ADRs:**

1. **ADR-001: Use Docling for Document Processing**
   - Context: Need to process PDF, DOCX, images with OCR
   - Alternatives: PyPDF2 + python-docx, Unstructured.io, Apache Tika
   - Decision rationale from STATE.md Phase 02-02

2. **ADR-002: Use Gemini 3.0 with Dynamic Model Selection**
   - Context: Need LLM for structured data extraction
   - Alternatives: GPT-4, Claude, local models
   - Dynamic selection: Flash for simple, Pro for complex
   - Temperature=1.0 decision from STATE.md Phase 03-01

3. **ADR-003: Use PostgreSQL for Relational Storage**
   - Context: Need to store borrowers with relationships (income, accounts, sources)
   - Alternatives: MongoDB, DynamoDB
   - Decision rationale: Source attribution requires joins

4. **ADR-004: Deploy on Cloud Run with Serverless Architecture**
   - Context: Need scalable deployment with minimal ops
   - Alternatives: GKE, Cloud Functions, Compute Engine
   - Direct VPC egress decision from STATE.md Phase 06-01

5. **ADR-005: Use Next.js 14 App Router for Frontend**
   - Context: Need modern React framework with SSR capability
   - Alternatives: Vite + React, Remix, plain React
   - Decision rationale from STATE.md Phase 01-02
  </action>
  <verify>
File contains ADR-001 through ADR-005 with proper MADR format:
- Status section present in each
- Context section present in each
- Decision section present in each
- Consequences (positive/negative) present in each
  </verify>
  <done>
Core technology ADRs created with consistent MADR format and alternatives documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Implementation-Specific ADRs</name>
  <files>docs/ARCHITECTURE_DECISIONS.md</files>
  <action>
Add additional ADRs documenting significant implementation decisions from each phase.

**Add these ADRs (reference STATE.md for accuracy):**

6. **ADR-006: Async Database Sessions with expire_on_commit=False**
   - Context: SQLAlchemy async sessions have lazy loading issues
   - Decision from Phase 02-01

7. **ADR-007: Repository Pattern with Caller-Controlled Transactions**
   - Context: Need clean separation between data access and business logic
   - Repository uses flush(), caller controls commit
   - Decision from Phase 02-01

8. **ADR-008: Document Chunking Strategy (4000 tokens, 200 overlap)**
   - Context: Large documents exceed LLM context limits
   - Overlap ensures entity boundaries preserved
   - Decision from Phase 03-02

9. **ADR-009: Deduplication Priority Order (SSN > Account > Fuzzy Name)**
   - Context: Same borrower may appear multiple times across documents
   - Priority order ensures most reliable identifiers matched first
   - Decision from Phase 03-04

10. **ADR-010: Confidence Threshold 0.7 for Review Flagging**
    - Context: Need to balance automation with accuracy
    - Low confidence extractions flagged for human review
    - Decision from Phase 03-03

11. **ADR-011: CORS Configuration for Local Development**
    - Context: Frontend and backend on different ports during development
    - Multiple origins configured (localhost:3000, localhost:5173, 127.0.0.1 variants)
    - Decision from Phase 04-02

12. **ADR-012: selectinload() for Eager Loading Relationships**
    - Context: Prevent N+1 query problems in borrower retrieval
    - Chained selectinload for nested relationships
    - Decision from Phase 04-01

Update the Index section to include all new ADRs.
  </action>
  <verify>
File contains ADR-006 through ADR-012 with proper format.
Index section updated with all ADR links.
  </verify>
  <done>
Implementation-specific ADRs added covering database, extraction, and API design decisions
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Infrastructure and Quality ADRs</name>
  <files>docs/ARCHITECTURE_DECISIONS.md</files>
  <action>
Complete the ADR document with infrastructure and quality decisions.

**Add these ADRs:**

13. **ADR-013: Private VPC for Cloud SQL (No Public IP)**
    - Context: Security best practice for database access
    - Cloud SQL only accessible via VPC peering
    - Decision from Phase 06-01

14. **ADR-014: Secret Manager for Credentials**
    - Context: Need secure credential storage without hardcoding
    - Environment variables injected via secret_key_ref
    - Decision from Phase 06-03

15. **ADR-015: pytest-asyncio Auto Mode for Testing**
    - Context: Simplify async test writing
    - Auto mode handles event loop lifecycle
    - Decision from pyproject.toml configuration

16. **ADR-016: In-Memory SQLite for Unit Tests**
    - Context: Fast, isolated database tests
    - aiosqlite for async compatibility
    - Decision from Phase 02-01

17. **ADR-017: Income Anomaly Thresholds (50% drop, 300% spike)**
    - Context: Need to flag suspicious income patterns
    - Thresholds balance false positive/negative rates
    - Decision from Phase 03-05

**Final touches:**
- Ensure index has all 17+ ADRs linked
- Add a "Decision Log by Phase" section at the end summarizing which phase each ADR originated from
- Total document should be 300+ lines

**Example Decision Log:**
```markdown
## Decision Log by Phase

| Phase | ADRs |
|-------|------|
| 1. Foundation | ADR-005 |
| 2. Ingestion | ADR-001, ADR-006, ADR-007, ADR-016 |
| 3. Extraction | ADR-002, ADR-008, ADR-009, ADR-010, ADR-017 |
| 4. API | ADR-003, ADR-011, ADR-012 |
| 5. Frontend | (covered by ADR-005) |
| 6. Infrastructure | ADR-004, ADR-013, ADR-014 |
| 7. Testing | ADR-015, ADR-016 |
```
  </action>
  <verify>
```bash
# Check ADR count and document length
grep -c "^## ADR-" docs/ARCHITECTURE_DECISIONS.md && \
grep -c "Decision Log by Phase" docs/ARCHITECTURE_DECISIONS.md && \
wc -l docs/ARCHITECTURE_DECISIONS.md
```
Document should have 15+ ADRs and 300+ lines.
  </verify>
  <done>
Complete ARCHITECTURE_DECISIONS.md with 15+ ADRs covering all major decisions, indexed and traced to phases
  </done>
</task>

</tasks>

<verification>
1. docs/ARCHITECTURE_DECISIONS.md exists with 300+ lines
2. Contains required ADRs: ADR-001 (Docling), ADR-002 (Gemini), ADR-003 (PostgreSQL), ADR-004 (Cloud Run), ADR-005 (Next.js)
3. Each ADR follows MADR format with Status, Context, Decision, Consequences
4. Alternatives Considered documented for major decisions
5. Decision Log by Phase provides traceability
6. Covers requirements DOCS-20 through DOCS-24
</verification>

<success_criteria>
- ARCHITECTURE_DECISIONS.md contains ADR-001 through ADR-005 as minimum (15+ total)
- Each ADR follows consistent MADR format
- Alternatives considered with pros/cons documented
- Decisions trace to specific phases and STATE.md entries
- Document is comprehensive (300+ lines)
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation-testing/07-02-SUMMARY.md`
</output>
