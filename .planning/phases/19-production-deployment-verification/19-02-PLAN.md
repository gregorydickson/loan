---
phase: 19-production-deployment-verification
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Frontend Cloud Run service is deployed and accessible in production"
    - "Frontend loads in browser without errors"
    - "Frontend is configured with correct backend API URL"
  artifacts:
    - path: "Cloud Run service: loan-frontend-prod"
      provides: "Frontend web UI deployment"
      verification: "gcloud run services describe loan-frontend-prod --region=us-central1"
  key_links:
    - from: "loan-frontend-prod"
      to: "loan-backend-prod"
      via: "NEXT_PUBLIC_API_URL build arg"
      pattern: "_BACKEND_URL"
---

<objective>
Deploy frontend service to Cloud Run production with correct backend API URL.

Purpose: Frontend must be built with NEXT_PUBLIC_API_URL baked in at build time - this requires the backend URL from Plan 19-01.
Output: Frontend service running at https://loan-frontend-prod-*.run.app that communicates with backend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-production-deployment-verification/19-RESEARCH.md
@.planning/phases/19-production-deployment-verification/19-01-SUMMARY.md
@infrastructure/cloudbuild/frontend-cloudbuild.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get backend URL and check frontend deployment</name>
  <files>None - verification only</files>
  <action>
    Retrieve backend URL and check if frontend already deployed:

    1. Get backend URL from production (deployed in Plan 19-01):
       ```bash
       BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")
       echo "Backend URL: $BACKEND_URL"
       ```
       If this fails, Plan 19-01 did not complete successfully.

    2. Check if frontend already deployed:
       ```bash
       gcloud run services describe loan-frontend-prod --region=us-central1 --format="value(status.url)" 2>/dev/null
       ```

    3. If frontend exists, capture URL for verification. If not, proceed to Task 2.

    4. Store BACKEND_URL for build substitution in Task 2.
  </action>
  <verify>BACKEND_URL is captured successfully (non-empty value)</verify>
  <done>Backend URL available; frontend deployment status known</done>
</task>

<task type="auto">
  <name>Task 2: Deploy frontend with backend URL (if needed)</name>
  <files>None - uses existing CloudBuild config</files>
  <action>
    Deploy frontend service with backend URL baked into build:

    1. If frontend NOT deployed:
       ```bash
       cd /Users/gregorydickson/stackpoint/loan

       # Get backend URL
       BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")

       # Deploy frontend with backend URL substitution
       gcloud builds submit \
           --config=infrastructure/cloudbuild/frontend-cloudbuild.yaml \
           --substitutions=SHORT_SHA=$(git rev-parse --short HEAD),_BACKEND_URL=$BACKEND_URL \
           .
       ```
       Note: Build takes ~5-10 minutes.

    2. If frontend IS deployed, skip to Task 3 verification.

    3. After deployment completes, verify service exists:
       ```bash
       gcloud run services describe loan-frontend-prod --region=us-central1 --format="table(SERVICE,URL)"
       ```

    4. Capture frontend URL:
       ```bash
       FRONTEND_URL=$(gcloud run services describe loan-frontend-prod --region=us-central1 --format="value(status.url)")
       echo "Frontend URL: $FRONTEND_URL"
       ```

    This satisfies DEPLOY-03.
  </action>
  <verify>
    gcloud run services describe loan-frontend-prod --region=us-central1 exits with status 0 and shows URL
  </verify>
  <done>Frontend service deployed (or already exists) with accessible URL</done>
</task>

<task type="auto">
  <name>Task 3: Verify frontend loads and connects to backend</name>
  <files>None - verification only</files>
  <action>
    Verify frontend is accessible and properly configured:

    1. Get frontend URL:
       ```bash
       FRONTEND_URL=$(gcloud run services describe loan-frontend-prod --region=us-central1 --format="value(status.url)")
       ```

    2. Check frontend responds with 200:
       ```bash
       HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}")
       echo "Frontend HTTP Status: $HTTP_STATUS"
       ```
       Expected: 200

    3. Verify HTML content loads:
       ```bash
       curl -s "${FRONTEND_URL}" | head -20
       ```
       Should show HTML doctype and Next.js application markup.

    4. If frontend fails to load, check build logs:
       ```bash
       # Get latest build ID for frontend
       gcloud builds list --limit=5 --format="table(id,status,createTime)" | grep frontend
       ```

    5. Document frontend URL for human verification in Phase 20.

    This is partial DEPLOY-06 (frontend portion).
  </action>
  <verify>curl to frontend URL returns HTTP 200 with HTML content</verify>
  <done>Frontend responds to requests with 200 status and loads HTML correctly</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Frontend service appears in `gcloud run services list`
2. Frontend URL loads: `curl $FRONTEND_URL` returns 200 with HTML
3. Backend URL was correctly passed during build

Commands to verify:
```bash
gcloud run services list --region=us-central1 | grep loan-frontend-prod
FRONTEND_URL=$(gcloud run services describe loan-frontend-prod --region=us-central1 --format="value(status.url)")
curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}"
```
</verification>

<success_criteria>
- DEPLOY-03: Frontend deployed to Cloud Run (or confirmed already deployed)
- Frontend built with correct BACKEND_URL
- Frontend returns 200 on HTTP request
- Frontend URL captured for Phase 20 Chrome testing
</success_criteria>

<output>
After completion, create `.planning/phases/19-production-deployment-verification/19-02-SUMMARY.md` with:
- Frontend URL deployed to
- Backend URL used for build
- HTTP response status
- HTML content verification (loads correctly)
</output>
