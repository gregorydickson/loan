---
phase: 19-production-deployment-verification
plan: 04
type: execute
wave: 3
depends_on: ["19-01", "19-02", "19-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All three services respond to health checks"
    - "Production environment variables and secrets are configured"
    - "Services can communicate with each other"
  artifacts:
    - path: "Secret Manager: database-url"
      provides: "Cloud SQL connection string"
      verification: "gcloud secrets list | grep database-url"
    - path: "Secret Manager: gemini-api-key"
      provides: "Gemini API key for extraction"
      verification: "gcloud secrets list | grep gemini-api-key"
  key_links:
    - from: "loan-backend-prod"
      to: "database-url secret"
      via: "--set-secrets"
      pattern: "DATABASE_URL=database-url:latest"
    - from: "loan-backend-prod"
      to: "gemini-api-key secret"
      via: "--set-secrets"
      pattern: "GEMINI_API_KEY=gemini-api-key:latest"
---

<objective>
Verify production secrets configuration and perform comprehensive health verification of all services.

Purpose: Final verification that all services are healthy, properly configured with secrets, and ready for Chrome-based testing in Phase 20.
Output: Verification report confirming all services healthy with checkpoint for user review.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-production-deployment-verification/19-RESEARCH.md
@.planning/phases/19-production-deployment-verification/19-01-SUMMARY.md
@.planning/phases/19-production-deployment-verification/19-02-SUMMARY.md
@.planning/phases/19-production-deployment-verification/19-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Secret Manager configuration</name>
  <files>None - verification only</files>
  <action>
    Verify required secrets exist and are accessible by backend:

    1. List all secrets:
       ```bash
       gcloud secrets list --format="table(name,createTime)"
       ```
       Expected: database-url, gemini-api-key

    2. Verify secrets have proper IAM bindings for Cloud Run service account:
       ```bash
       # Check database-url permissions
       gcloud secrets get-iam-policy database-url \
           --format="table(bindings.members,bindings.role)" 2>/dev/null || echo "IAM check requires permissions"
       ```

    3. Verify backend service has secrets mounted:
       ```bash
       gcloud run services describe loan-backend-prod --region=us-central1 \
           --format="yaml(spec.template.spec.containers[0].env)" | grep -A2 DATABASE_URL
       ```
       Expected: Shows DATABASE_URL and GEMINI_API_KEY referenced from Secret Manager

    4. Document any missing secrets or IAM issues.

    This satisfies DEPLOY-05.
  </action>
  <verify>gcloud secrets list shows database-url and gemini-api-key; backend env shows secret references</verify>
  <done>Production secrets verified as configured and accessible by backend service</done>
</task>

<task type="auto">
  <name>Task 2: Run comprehensive health verification</name>
  <files>None - verification only</files>
  <action>
    Perform comprehensive health check of all three services:

    1. Get all service URLs:
       ```bash
       BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")
       FRONTEND_URL=$(gcloud run services describe loan-frontend-prod --region=us-central1 --format="value(status.url)")
       GPU_URL=$(gcloud run services describe lightonocr-gpu --region=us-central1 --format="value(status.url)" 2>/dev/null || echo "")

       echo "Backend URL: $BACKEND_URL"
       echo "Frontend URL: $FRONTEND_URL"
       echo "GPU URL: ${GPU_URL:-'Not deployed yet'}"
       ```

    2. Verify backend health:
       ```bash
       echo "=== Backend Health ==="
       curl -s -w "\nHTTP Status: %{http_code}\n" "${BACKEND_URL}/health"
       ```

    3. Verify frontend loads:
       ```bash
       echo "=== Frontend Check ==="
       HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}")
       echo "Frontend HTTP Status: $HTTP_STATUS"
       ```

    4. Verify GPU service (if deployed):
       ```bash
       echo "=== GPU Service Check ==="
       if [ -n "$GPU_URL" ]; then
           TOKEN=$(gcloud auth print-identity-token)
           curl -s --max-time 60 -H "Authorization: Bearer ${TOKEN}" "${GPU_URL}/health" || echo "GPU cold start or health unavailable"
       else
           echo "GPU service not yet deployed - verify build status"
           gcloud builds list --limit=3 --format="table(id,status,createTime)"
       fi
       ```

    5. Generate summary table:
       ```bash
       echo ""
       echo "=== Production Services Summary ==="
       gcloud run services list --region=us-central1 --format="table(SERVICE,URL,LAST_DEPLOYED_AT)"
       ```

    This completes DEPLOY-06.
  </action>
  <verify>All services respond: backend 200 + healthy JSON, frontend 200, GPU authenticated health (or build in progress)</verify>
  <done>Comprehensive health verification completed with all services documented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Production deployment verification completed for all three services:
    - Backend API (loan-backend-prod) with health endpoint
    - Frontend web app (loan-frontend-prod) with HTML loading
    - GPU OCR service (lightonocr-gpu) with L4 GPU and scale-to-zero
  </what-built>
  <how-to-verify>
    1. Review the service URLs printed in Task 2 output

    2. Open the Frontend URL in Chrome browser:
       - Page should load without errors
       - Check browser console for any JavaScript errors
       - Verify the page shows the loan document extraction UI

    3. Verify Backend API in browser or terminal:
       - Visit {BACKEND_URL}/health - should show healthy JSON
       - Visit {BACKEND_URL}/docs - should show FastAPI Swagger UI (if available)

    4. GPU service verification (optional - may be in cold start):
       - GPU service requires authentication
       - Cold start takes 10-40 seconds
       - Can be verified in Phase 20 when testing scanned documents

    5. Confirm all services are ready for Phase 20 Chrome testing
  </how-to-verify>
  <resume-signal>Type "approved" if services are healthy and ready for Phase 20, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 19 requirements verification:

| Requirement | Status | Verification |
|-------------|--------|--------------|
| DEPLOY-01 | Plan 19-01 | gcloud run services list |
| DEPLOY-02 | Plan 19-01 | loan-backend-prod deployed |
| DEPLOY-03 | Plan 19-02 | loan-frontend-prod deployed |
| DEPLOY-04 | Plan 19-03 | lightonocr-gpu deployed |
| DEPLOY-05 | Plan 19-04 | Secrets verified |
| DEPLOY-06 | Plan 19-04 | Health checks passed |

All services should be accessible at their Cloud Run URLs.
</verification>

<success_criteria>
- All DEPLOY-01 through DEPLOY-06 requirements satisfied
- Backend health check returns 200 + healthy status
- Frontend loads with 200 status
- GPU service deployed with L4 GPU (or build in progress)
- User confirms services are ready for Phase 20
</success_criteria>

<output>
After completion, create `.planning/phases/19-production-deployment-verification/19-04-SUMMARY.md` with:
- Complete service URL list
- Health check results for each service
- Secrets verification status
- User verification outcome
- Any issues or notes for Phase 20
</output>
