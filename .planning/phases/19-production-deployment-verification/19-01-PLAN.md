---
phase: 19-production-deployment-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Backend Cloud Run service is deployed and accessible in production"
    - "Backend health endpoint returns 200 status"
    - "Backend has access to Cloud SQL database via VPC"
  artifacts:
    - path: "Cloud Run service: loan-backend-prod"
      provides: "Backend API deployment"
      verification: "gcloud run services describe loan-backend-prod --region=us-central1"
  key_links:
    - from: "loan-backend-prod"
      to: "Cloud SQL (loan-db-prod)"
      via: "VPC egress"
      pattern: "network.*vpc.*subnet"
    - from: "loan-backend-prod"
      to: "Secret Manager"
      via: "set-secrets"
      pattern: "database-url.*gemini-api-key"
---

<objective>
Check existing GCP deployments and deploy backend service to Cloud Run production.

Purpose: Establish the backend API as the foundation for frontend deployment (which requires BACKEND_URL at build time).
Output: Backend service running at https://loan-backend-prod-*.run.app with healthy status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-production-deployment-verification/19-RESEARCH.md
@infrastructure/cloudbuild/backend-cloudbuild.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check existing Cloud Run deployments</name>
  <files>None - verification only</files>
  <action>
    Check current deployment state in production GCP project:

    1. Verify correct GCP project is set:
       ```bash
       gcloud config get-value project
       ```

    2. List all Cloud Run services in us-central1:
       ```bash
       gcloud run services list --region=us-central1 --format="table(SERVICE,URL,LAST_DEPLOYED_AT)"
       ```

    3. Check for expected services:
       - loan-backend-prod
       - loan-frontend-prod
       - lightonocr-gpu

    4. Record which services exist and which need deployment.

    5. If backend exists, get its URL for later use:
       ```bash
       gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)"
       ```

    This task is DEPLOY-01 verification. Document findings clearly.
  </action>
  <verify>gcloud run services list command executes without error and shows current service state</verify>
  <done>Current deployment state documented: list of existing/missing services captured</done>
</task>

<task type="auto">
  <name>Task 2: Deploy backend to Cloud Run (if needed)</name>
  <files>None - uses existing CloudBuild config</files>
  <action>
    Deploy backend service using existing CloudBuild configuration:

    1. If backend NOT deployed (from Task 1):
       ```bash
       cd /Users/gregorydickson/stackpoint/loan
       gcloud builds submit \
           --config=infrastructure/cloudbuild/backend-cloudbuild.yaml \
           --substitutions=SHORT_SHA=$(git rev-parse --short HEAD) \
           .
       ```
       Note: Build takes ~5-10 minutes. Watch for completion.

    2. If backend IS deployed, skip to verification.

    3. After deployment completes, verify service exists:
       ```bash
       gcloud run services describe loan-backend-prod --region=us-central1 --format="table(SERVICE,URL)"
       ```

    4. Capture the backend URL for use in Plan 19-02:
       ```bash
       BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")
       echo "Backend URL: $BACKEND_URL"
       ```

    This satisfies DEPLOY-02.
  </action>
  <verify>
    gcloud run services describe loan-backend-prod --region=us-central1 exits with status 0 and shows URL
  </verify>
  <done>Backend service deployed (or already exists) with accessible URL captured</done>
</task>

<task type="auto">
  <name>Task 3: Verify backend health and database connectivity</name>
  <files>None - verification only</files>
  <action>
    Verify backend is healthy and can connect to Cloud SQL:

    1. Get backend URL:
       ```bash
       BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")
       ```

    2. Check health endpoint:
       ```bash
       curl -s "${BACKEND_URL}/health"
       ```
       Expected: {"status": "healthy"} or similar JSON response with 200 status

    3. Verify API is functional (optional - tests DB connection):
       ```bash
       curl -s "${BACKEND_URL}/api/health" || curl -s "${BACKEND_URL}/api/v1/health"
       ```

    4. If health fails, check Cloud Run logs for errors:
       ```bash
       gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=loan-backend-prod" \
           --limit=20 --format="table(timestamp,textPayload)"
       ```

    5. Document health status and any issues found.

    This is partial DEPLOY-06 (backend portion).
  </action>
  <verify>curl to /health returns HTTP 200 with healthy status JSON</verify>
  <done>Backend responds to health check with 200 status and healthy response</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Backend service appears in `gcloud run services list`
2. Backend URL is accessible: `curl $BACKEND_URL/health` returns 200
3. No error logs in Cloud Logging for backend service

Commands to verify:
```bash
gcloud run services list --region=us-central1 | grep loan-backend-prod
BACKEND_URL=$(gcloud run services describe loan-backend-prod --region=us-central1 --format="value(status.url)")
curl -s -o /dev/null -w "%{http_code}" "${BACKEND_URL}/health"
```
</verification>

<success_criteria>
- DEPLOY-01: Check for existing deployments completed
- DEPLOY-02: Backend deployed to Cloud Run (or confirmed already deployed)
- Backend health check returns 200 status
- Backend URL captured for Plan 19-02 frontend deployment
</success_criteria>

<output>
After completion, create `.planning/phases/19-production-deployment-verification/19-01-SUMMARY.md` with:
- Deployment state found (which services existed)
- Backend URL deployed to
- Health check result
- Any issues encountered
</output>
