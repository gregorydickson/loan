---
phase: 09-cloud-tasks-background-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/src/config.py
  - backend/src/ingestion/cloud_tasks_client.py
  - infrastructure/terraform/iam.tf
autonomous: true

must_haves:
  truths:
    - "CloudTasksClient can create document processing tasks with OIDC authentication"
    - "Settings include all Cloud Tasks configuration (project_id, location, queue, service_url, service_account)"
    - "google-cloud-tasks library is installed and importable"
  artifacts:
    - path: "backend/src/ingestion/cloud_tasks_client.py"
      provides: "Cloud Tasks client wrapper for task creation"
      exports: ["CloudTasksClient"]
    - path: "backend/src/config.py"
      provides: "Cloud Tasks configuration settings"
      contains: "gcp_project_id"
    - path: "backend/pyproject.toml"
      provides: "google-cloud-tasks dependency"
      contains: "google-cloud-tasks"
  key_links:
    - from: "backend/src/ingestion/cloud_tasks_client.py"
      to: "google.cloud.tasks_v2"
      via: "CloudTasksClient import"
      pattern: "from google.cloud import tasks_v2"
---

<objective>
Add Cloud Tasks client and configuration for async document processing

Purpose: Establish the infrastructure layer for queueing document extraction tasks to Cloud Tasks. This enables upload endpoints to return immediately while extraction runs asynchronously.

Output: CloudTasksClient class that can create HTTP target tasks with OIDC authentication, plus all required configuration settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cloud-tasks-background-processing/09-RESEARCH.md

# Current implementation
@backend/src/config.py
@backend/src/ingestion/document_service.py
@infrastructure/terraform/cloud_tasks.tf
@infrastructure/terraform/iam.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add google-cloud-tasks dependency and Cloud Tasks settings</name>
  <files>backend/pyproject.toml, backend/src/config.py</files>
  <action>
1. Add google-cloud-tasks>=2.21.0 to dependencies in pyproject.toml (after google-cloud-storage)

2. Add Cloud Tasks settings to Settings class in config.py:
   - gcp_project_id: str = Field(default="", description="GCP project ID for Cloud Tasks")
   - gcp_location: str = Field(default="us-central1", description="GCP region for Cloud Tasks queue")
   - cloud_tasks_queue: str = Field(default="document-processing", description="Cloud Tasks queue name")
   - cloud_run_service_url: str = Field(default="", description="Cloud Run backend service URL for task callbacks")
   - cloud_run_service_account: str = Field(default="", description="Service account email for OIDC token")

Note: All fields have empty string defaults to allow local development without Cloud Tasks.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && pip install -e ".[dev]" && python -c "from google.cloud import tasks_v2; print('OK')"`
Verify settings: `python -c "from src.config import settings; print(settings.gcp_project_id, settings.cloud_tasks_queue)"`
  </verify>
  <done>google-cloud-tasks is installed and Settings includes all Cloud Tasks configuration fields</done>
</task>

<task type="auto">
  <name>Task 2: Create CloudTasksClient wrapper class</name>
  <files>backend/src/ingestion/cloud_tasks_client.py</files>
  <action>
Create backend/src/ingestion/cloud_tasks_client.py with CloudTasksClient class:

```python
"""Cloud Tasks client for async document processing.

Creates HTTP target tasks with OIDC authentication for Cloud Run.
"""

from __future__ import annotations

import json
import logging
from uuid import UUID

from google.cloud import tasks_v2
from google.protobuf import duration_pb2

logger = logging.getLogger(__name__)


class CloudTasksClient:
    """Client for creating Cloud Tasks to process documents.

    Creates HTTP POST tasks targeting /api/tasks/process-document
    with OIDC authentication for secure Cloud Run invocation.
    """

    def __init__(
        self,
        project_id: str,
        location: str,
        queue_id: str,
        service_url: str,
        service_account_email: str,
    ) -> None:
        """Initialize Cloud Tasks client.

        Args:
            project_id: GCP project ID
            location: GCP region (e.g., us-central1)
            queue_id: Cloud Tasks queue name
            service_url: Cloud Run service URL for callbacks
            service_account_email: Service account for OIDC token
        """
        self.client = tasks_v2.CloudTasksClient()
        self.queue_path = self.client.queue_path(project_id, location, queue_id)
        self.service_url = service_url.rstrip("/")  # Remove trailing slash
        self.service_account_email = service_account_email

        logger.info(
            "CloudTasksClient initialized: queue=%s, target=%s",
            self.queue_path,
            self.service_url,
        )

    def create_document_processing_task(
        self,
        document_id: UUID,
        filename: str,
    ) -> tasks_v2.Task:
        """Create a task to process a document.

        Args:
            document_id: Document UUID to process
            filename: Original filename (for logging)

        Returns:
            Created Cloud Task
        """
        payload = json.dumps({
            "document_id": str(document_id),
            "filename": filename,
        }).encode()

        # Construct target URL
        target_url = f"{self.service_url}/api/tasks/process-document"

        # Task with OIDC authentication for Cloud Run
        task = tasks_v2.Task(
            http_request=tasks_v2.HttpRequest(
                http_method=tasks_v2.HttpMethod.POST,
                url=target_url,
                headers={"Content-Type": "application/json"},
                body=payload,
                oidc_token=tasks_v2.OidcToken(
                    service_account_email=self.service_account_email,
                    audience=self.service_url,
                ),
            ),
            # 10-minute timeout per attempt
            dispatch_deadline=duration_pb2.Duration(seconds=600),
        )

        created_task = self.client.create_task(
            tasks_v2.CreateTaskRequest(
                parent=self.queue_path,
                task=task,
            )
        )

        logger.info(
            "Created task for document %s: %s",
            document_id,
            created_task.name,
        )

        return created_task
```

Key design decisions:
- 10-minute dispatch_deadline (matches Cloud Tasks queue config, sufficient for Docling + LLM)
- OIDC token with service_url as audience (Cloud Run validates automatically)
- JSON payload with document_id and filename
- Logging for task creation debugging
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.ingestion.cloud_tasks_client import CloudTasksClient; print('Import OK')"`
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -m mypy src/ingestion/cloud_tasks_client.py --strict`
  </verify>
  <done>CloudTasksClient class exists with create_document_processing_task method</done>
</task>

<task type="auto">
  <name>Task 3: Add Cloud Run invoker IAM role for task handler</name>
  <files>infrastructure/terraform/iam.tf</files>
  <action>
Add IAM binding for Cloud Run invoker role so the service account can invoke itself (for Cloud Tasks callbacks):

After the existing cloudtasks_enqueuer role binding, add:

```hcl
# Role: Cloud Run Invoker - Allow service account to invoke Cloud Run
# Required for Cloud Tasks OIDC authentication when calling /api/tasks/process-document
resource "google_project_iam_member" "run_invoker" {
  project = var.project_id
  role    = "roles/run.invoker"
  member  = "serviceAccount:${google_service_account.cloud_run_sa.email}"
}
```

This allows the Cloud Run service account to invoke Cloud Run services with OIDC tokens. Cloud Tasks uses this to authenticate the /api/tasks/process-document callback.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/infrastructure/terraform && terraform validate`
Check file contains roles/run.invoker binding
  </verify>
  <done>IAM role for Cloud Run invoker is configured in Terraform</done>
</task>

</tasks>

<verification>
1. google-cloud-tasks is in pyproject.toml and can be imported
2. Settings class has all Cloud Tasks configuration fields
3. CloudTasksClient imports without error and passes mypy strict
4. Terraform validates with new IAM role
</verification>

<success_criteria>
- `pip install -e ".[dev]"` succeeds with google-cloud-tasks
- `from src.ingestion.cloud_tasks_client import CloudTasksClient` works
- `from src.config import settings; settings.cloud_tasks_queue` returns "document-processing"
- `terraform validate` passes in infrastructure/terraform
</success_criteria>

<output>
After completion, create `.planning/phases/09-cloud-tasks-background-processing/09-01-SUMMARY.md`
</output>
