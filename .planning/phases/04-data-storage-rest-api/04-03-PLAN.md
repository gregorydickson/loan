---
phase: 04-data-storage-rest-api
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/src/api/borrowers.py
  - backend/src/api/dependencies.py
  - backend/src/main.py
  - backend/tests/unit/test_borrower_routes.py
autonomous: true

must_haves:
  truths:
    - "GET /api/borrowers lists borrowers with pagination"
    - "GET /api/borrowers/{id} returns full borrower with income, accounts, sources"
    - "GET /api/borrowers/{id}/sources returns source documents for borrower"
    - "GET /api/borrowers/search finds borrowers by name or account number"
    - "Invalid borrower ID returns 404 with consistent error format"
  artifacts:
    - path: "backend/src/api/borrowers.py"
      provides: "Borrower API endpoints"
      exports: ["router"]
      min_lines: 150
    - path: "backend/tests/unit/test_borrower_routes.py"
      provides: "Unit tests for borrower endpoints"
      min_lines: 100
  key_links:
    - from: "backend/src/api/borrowers.py"
      to: "backend/src/storage/repositories.py"
      via: "BorrowerRepository dependency injection"
      pattern: "BorrowerRepoDep"
    - from: "backend/src/main.py"
      to: "backend/src/api/borrowers.py"
      via: "app.include_router(borrowers_router)"
      pattern: "include_router.*borrowers"
---

<objective>
Create complete borrower API endpoints with search and pagination

Purpose: Expose extracted borrower data through REST API endpoints, enabling the frontend to list, search, and view detailed borrower information with source traceability.

Output: borrowers.py with all endpoints, dependency injection wiring, unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-storage-rest-api/04-RESEARCH.md
@.planning/phases/04-data-storage-rest-api/04-01-SUMMARY.md

# Existing patterns to follow
@backend/src/api/documents.py
@backend/src/api/dependencies.py
@backend/src/storage/repositories.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create borrower API endpoints</name>
  <files>backend/src/api/borrowers.py</files>
  <action>
Create backend/src/api/borrowers.py with all borrower endpoints.

**Response models (at top of file):**

```python
from datetime import datetime
from decimal import Decimal
from typing import Annotated
from uuid import UUID

from fastapi import APIRouter, HTTPException, Query, status
from pydantic import BaseModel, ConfigDict

from src.api.dependencies import BorrowerRepoDep

router = APIRouter(prefix="/api/borrowers", tags=["borrowers"])


class IncomeRecordResponse(BaseModel):
    """Income record in borrower response."""
    model_config = ConfigDict(from_attributes=True)

    id: UUID
    amount: Decimal
    period: str
    year: int
    source_type: str
    employer: str | None


class AccountNumberResponse(BaseModel):
    """Account number in borrower response."""
    model_config = ConfigDict(from_attributes=True)

    id: UUID
    number: str
    account_type: str


class SourceReferenceResponse(BaseModel):
    """Source reference in borrower response."""
    model_config = ConfigDict(from_attributes=True)

    id: UUID
    document_id: UUID
    page_number: int
    section: str | None
    snippet: str


class BorrowerSummaryResponse(BaseModel):
    """Borrower summary for list views (fewer fields)."""
    model_config = ConfigDict(from_attributes=True)

    id: UUID
    name: str
    confidence_score: Decimal
    created_at: datetime
    income_count: int  # Computed from len(income_records)


class BorrowerDetailResponse(BaseModel):
    """Full borrower details with all relationships."""
    model_config = ConfigDict(from_attributes=True)

    id: UUID
    name: str
    address_json: str | None
    confidence_score: Decimal
    created_at: datetime
    income_records: list[IncomeRecordResponse]
    account_numbers: list[AccountNumberResponse]
    source_references: list[SourceReferenceResponse]


class BorrowerListResponse(BaseModel):
    """Paginated list of borrowers."""
    borrowers: list[BorrowerSummaryResponse]
    total: int
    limit: int
    offset: int


class BorrowerSourcesResponse(BaseModel):
    """Source documents for a borrower."""
    borrower_id: UUID
    borrower_name: str
    sources: list[SourceReferenceResponse]
```

**Endpoints to implement:**

1. `GET /api/borrowers` - List borrowers with pagination
```python
@router.get("/", response_model=BorrowerListResponse)
async def list_borrowers(
    repository: BorrowerRepoDep,
    limit: int = Query(default=100, ge=1, le=1000),
    offset: int = Query(default=0, ge=0),
) -> BorrowerListResponse:
    borrowers = await repository.list_borrowers(limit=limit, offset=offset)
    total = await repository.count()
    return BorrowerListResponse(
        borrowers=[
            BorrowerSummaryResponse(
                id=b.id,
                name=b.name,
                confidence_score=b.confidence_score,
                created_at=b.created_at,
                income_count=len(b.income_records),
            )
            for b in borrowers
        ],
        total=total,
        limit=limit,
        offset=offset,
    )
```

2. `GET /api/borrowers/search` - Search by name or account (MUST be before /{id})
```python
@router.get("/search", response_model=BorrowerListResponse)
async def search_borrowers(
    repository: BorrowerRepoDep,
    name: Annotated[str | None, Query(min_length=2)] = None,
    account_number: Annotated[str | None, Query(min_length=3)] = None,
    limit: int = Query(default=100, ge=1, le=1000),
    offset: int = Query(default=0, ge=0),
) -> BorrowerListResponse:
    if not name and not account_number:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Either 'name' or 'account_number' query parameter is required",
        )

    if name:
        borrowers = await repository.search_by_name(name, limit=limit, offset=offset)
    else:
        borrowers = await repository.search_by_account(account_number, limit=limit, offset=offset)

    return BorrowerListResponse(
        borrowers=[
            BorrowerSummaryResponse(
                id=b.id,
                name=b.name,
                confidence_score=b.confidence_score,
                created_at=b.created_at,
                income_count=len(b.income_records),
            )
            for b in borrowers
        ],
        total=len(borrowers),  # Search doesn't have separate count
        limit=limit,
        offset=offset,
    )
```

3. `GET /api/borrowers/{id}` - Get borrower details
```python
@router.get("/{borrower_id}", response_model=BorrowerDetailResponse)
async def get_borrower(
    borrower_id: UUID,
    repository: BorrowerRepoDep,
) -> BorrowerDetailResponse:
    borrower = await repository.get_by_id(borrower_id)
    if not borrower:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Borrower not found: {borrower_id}",
        )
    return BorrowerDetailResponse.model_validate(borrower)
```

4. `GET /api/borrowers/{id}/sources` - Get source documents
```python
@router.get("/{borrower_id}/sources", response_model=BorrowerSourcesResponse)
async def get_borrower_sources(
    borrower_id: UUID,
    repository: BorrowerRepoDep,
) -> BorrowerSourcesResponse:
    borrower = await repository.get_by_id(borrower_id)
    if not borrower:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Borrower not found: {borrower_id}",
        )
    return BorrowerSourcesResponse(
        borrower_id=borrower.id,
        borrower_name=borrower.name,
        sources=[
            SourceReferenceResponse.model_validate(src)
            for src in borrower.source_references
        ],
    )
```

**Route ordering matters:** /search MUST come before /{borrower_id} to avoid "search" being interpreted as a UUID.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.borrowers import router; print([r.path for r in router.routes])"`
  </verify>
  <done>borrowers.py has 4 endpoints: list, search, get detail, get sources</done>
</task>

<task type="auto">
  <name>Task 2: Wire BorrowerRepository dependency and router</name>
  <files>backend/src/api/dependencies.py, backend/src/main.py</files>
  <action>
**Update dependencies.py:**

Add BorrowerRepository dependency function and type alias:

```python
from src.storage.repositories import DocumentRepository, BorrowerRepository

def get_borrower_repository(session: DBSession) -> BorrowerRepository:
    """Get borrower repository with session."""
    return BorrowerRepository(session)

BorrowerRepoDep = Annotated[BorrowerRepository, Depends(get_borrower_repository)]
```

**Update main.py:**

Add borrowers router import and registration:

```python
from src.api.borrowers import router as borrowers_router

# After documents_router
app.include_router(borrowers_router)
```

The order of router registration:
1. documents_router
2. borrowers_router
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.main import app; print([r.path for r in app.routes if 'borrower' in r.path])"`
Should show borrower routes.
  </verify>
  <done>BorrowerRepoDep defined, borrowers_router registered in main.py</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for borrower endpoints</name>
  <files>backend/tests/unit/test_borrower_routes.py</files>
  <action>
Create unit tests for borrower API endpoints using httpx AsyncClient.

**Test setup:**
- Use pytest-asyncio
- Use TestClient or httpx.AsyncClient with app
- Mock BorrowerRepository with sample data

**Test cases:**

1. `test_list_borrowers_returns_paginated_response`:
   - Mock repository.list_borrowers and repository.count
   - Assert response has borrowers, total, limit, offset

2. `test_list_borrowers_respects_pagination`:
   - Call with limit=10, offset=5
   - Assert repository called with correct params

3. `test_search_by_name_returns_matches`:
   - Mock repository.search_by_name
   - Call /search?name=john
   - Assert correct borrowers returned

4. `test_search_by_account_returns_matches`:
   - Mock repository.search_by_account
   - Call /search?account_number=12345
   - Assert correct borrowers returned

5. `test_search_requires_parameter`:
   - Call /search without name or account_number
   - Assert 400 error

6. `test_get_borrower_returns_detail`:
   - Mock repository.get_by_id with full borrower
   - Assert all fields returned including relationships

7. `test_get_borrower_not_found`:
   - Mock repository.get_by_id returning None
   - Assert 404 error

8. `test_get_borrower_sources`:
   - Mock borrower with source_references
   - Assert sources returned

**Use dependency overrides to inject mock repository:**
```python
from fastapi.testclient import TestClient
from unittest.mock import AsyncMock, MagicMock

def test_example(client):
    mock_repo = AsyncMock()
    mock_repo.list_borrowers.return_value = [sample_borrower]
    mock_repo.count.return_value = 1

    app.dependency_overrides[get_borrower_repository] = lambda: mock_repo
    response = client.get("/api/borrowers/")
    assert response.status_code == 200
```
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -m pytest tests/unit/test_borrower_routes.py -v --tb=short`
  </verify>
  <done>8 test cases covering list, search, get, sources endpoints with pagination and error handling</done>
</task>

</tasks>

<verification>
1. Endpoints importable: `python -c "from src.api.borrowers import router"`
2. App routes include borrowers: `python -c "from src.main import app; print([r.path for r in app.routes])"`
3. All tests pass: `pytest tests/unit/test_borrower_routes.py -v`
4. Type check: `mypy src/api/borrowers.py --ignore-missing-imports`
</verification>

<success_criteria>
- GET /api/borrowers returns paginated list with total count
- GET /api/borrowers/search accepts name or account_number query params
- GET /api/borrowers/{id} returns full borrower with income, accounts, sources
- GET /api/borrowers/{id}/sources returns source references
- 404 returned for missing borrower IDs
- 400 returned for search without parameters
- 8 unit tests pass
- OpenAPI docs show all borrower endpoints at /docs
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-storage-rest-api/04-03-SUMMARY.md`
</output>
