---
phase: 04-data-storage-rest-api
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/main.py
  - backend/src/api/documents.py
  - backend/src/api/dependencies.py
autonomous: true

must_haves:
  truths:
    - "FastAPI app has CORS middleware allowing frontend origins"
    - "GET /api/documents/{id}/status returns lightweight status response"
    - "Custom exception handlers return consistent error format"
    - "Invalid requests return appropriate 4xx status codes"
  artifacts:
    - path: "backend/src/main.py"
      provides: "CORS middleware and exception handlers"
      contains: "CORSMiddleware"
    - path: "backend/src/api/documents.py"
      provides: "Document status endpoint"
      contains: "get_document_status"
  key_links:
    - from: "backend/src/main.py"
      to: "backend/src/api/documents.py"
      via: "app.include_router(documents_router)"
      pattern: "include_router.*documents"
---

<objective>
Add CORS middleware, custom exception handlers, and document status endpoint

Purpose: Complete the document API with status endpoint for polling, add CORS for frontend integration, and standardize error responses across all endpoints.

Output: Updated main.py with middleware/handlers, status endpoint in documents.py
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-storage-rest-api/04-RESEARCH.md

# Existing files to modify
@backend/src/main.py
@backend/src/api/documents.py
@backend/src/api/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CORS middleware and exception handlers to main.py</name>
  <files>backend/src/main.py</files>
  <action>
Modify main.py to add CORS middleware and custom exception handlers.

**CORS Configuration (add BEFORE routers):**
```python
from fastapi.middleware.cors import CORSMiddleware

# Add immediately after app = FastAPI(...)
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",      # Next.js dev
        "http://localhost:5173",      # Vite dev
        "http://127.0.0.1:3000",
        "http://127.0.0.1:5173",
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["*"],
)
```

**Custom exception handlers:**

1. Add EntityNotFoundError class:
```python
class EntityNotFoundError(Exception):
    """Raised when a requested entity is not found."""
    def __init__(self, entity_type: str, entity_id: str):
        self.entity_type = entity_type
        self.entity_id = entity_id
        super().__init__(f"{entity_type} not found: {entity_id}")
```

2. Add handler:
```python
from fastapi import Request
from fastapi.responses import JSONResponse

@app.exception_handler(EntityNotFoundError)
async def entity_not_found_handler(
    request: Request, exc: EntityNotFoundError
) -> JSONResponse:
    return JSONResponse(
        status_code=404,
        content={"detail": f"{exc.entity_type} not found: {exc.entity_id}"},
    )
```

3. Add generic exception handler for 500 errors:
```python
@app.exception_handler(Exception)
async def generic_exception_handler(
    request: Request, exc: Exception
) -> JSONResponse:
    # Log the error in production
    import structlog
    logger = structlog.get_logger()
    logger.error("Unhandled exception", exc_info=exc, path=request.url.path)
    return JSONResponse(
        status_code=500,
        content={"detail": "Internal server error"},
    )
```

**IMPORTANT:** CORS middleware MUST be added FIRST, before exception handlers and routers are registered. The order in FastAPI matters.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.main import app; print([m.__class__.__name__ for m in app.user_middleware])"`
Should show CORSMiddleware in the list.
  </verify>
  <done>main.py has CORSMiddleware added first, EntityNotFoundError exception handler, generic 500 handler</done>
</task>

<task type="auto">
  <name>Task 2: Add document status endpoint</name>
  <files>backend/src/api/documents.py</files>
  <action>
Add GET /api/documents/{id}/status endpoint to documents.py.

**Add response model:**
```python
class DocumentStatusResponse(BaseModel):
    """Lightweight status response for polling."""
    id: UUID
    status: str
    page_count: int | None = None
    error_message: str | None = None
```

**Add endpoint:**
```python
@router.get(
    "/{document_id}/status",
    response_model=DocumentStatusResponse,
    summary="Get document processing status",
    description="Lightweight endpoint for polling document status. Use this instead of GET /{id} when only status is needed.",
)
async def get_document_status(
    document_id: UUID,
    repository: DocumentRepoDep,
) -> DocumentStatusResponse:
    """Get document processing status.

    Args:
        document_id: Document UUID
        repository: DocumentRepository (injected)

    Returns:
        DocumentStatusResponse with status, page_count, error_message

    Raises:
        404: Document not found
    """
    document = await repository.get_by_id(document_id)
    if not document:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Document not found: {document_id}",
        )

    return DocumentStatusResponse(
        id=document.id,
        status=document.status.value,
        page_count=document.page_count,
        error_message=document.error_message,
    )
```

**IMPORTANT:** Place this endpoint BEFORE the `/{document_id}` endpoint in the file to avoid route matching issues (more specific routes first).
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.documents import router; print([r.path for r in router.routes])"`
Should include "/{document_id}/status" in the route list.
  </verify>
  <done>GET /api/documents/{id}/status endpoint returns lightweight status response</done>
</task>

<task type="auto">
  <name>Task 3: Export EntityNotFoundError from main for API use</name>
  <files>backend/src/api/dependencies.py</files>
  <action>
The EntityNotFoundError needs to be importable by API modules. Since it's defined in main.py (where the handler is registered), we have two options:

**Option A (recommended):** Create a dedicated errors module and import into main.py

Create backend/src/api/errors.py:
```python
"""Custom API exceptions."""

class EntityNotFoundError(Exception):
    """Raised when a requested entity is not found."""
    def __init__(self, entity_type: str, entity_id: str):
        self.entity_type = entity_type
        self.entity_id = entity_id
        super().__init__(f"{entity_type} not found: {entity_id}")
```

Then update main.py to import from there:
```python
from src.api.errors import EntityNotFoundError
```

This allows other API modules to use:
```python
from src.api.errors import EntityNotFoundError
raise EntityNotFoundError("Borrower", str(borrower_id))
```

**Update dependencies.py** to add the import so it's easily accessible:
```python
# At the end of dependencies.py
from src.api.errors import EntityNotFoundError

__all__ = [
    "DBSession",
    "GCSClientDep",
    "DoclingProcessorDep",
    "DocumentRepoDep",
    "DocumentServiceDep",
    "EntityNotFoundError",
]
```
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.errors import EntityNotFoundError; print('EntityNotFoundError importable')"`
  </verify>
  <done>EntityNotFoundError is in dedicated errors.py module and importable by API endpoints</done>
</task>

</tasks>

<verification>
1. CORS middleware active: `curl -I -X OPTIONS http://localhost:8000/api/documents/ -H "Origin: http://localhost:3000"` returns Access-Control headers
2. Status endpoint works: `python -c "from src.api.documents import router; print('/{document_id}/status' in [r.path for r in router.routes])"`
3. Exception importable: `python -c "from src.api.errors import EntityNotFoundError"`
4. App starts: `uvicorn src.main:app --host 0.0.0.0 --port 8000` (Ctrl+C to stop)
</verification>

<success_criteria>
- CORSMiddleware configured with localhost:3000 and localhost:5173 origins
- EntityNotFoundError defined in src/api/errors.py
- Exception handler for EntityNotFoundError returns 404 with consistent format
- Generic exception handler for 500 errors with logging
- GET /api/documents/{id}/status endpoint returns lightweight response
- All endpoints still work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-storage-rest-api/04-02-SUMMARY.md`
</output>
