---
phase: 04-data-storage-rest-api
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/main.py
  - backend/src/api/documents.py
  - backend/src/api/errors.py
  - backend/src/api/dependencies.py
autonomous: true

must_haves:
  truths:
    - "FastAPI app has CORS middleware allowing frontend origins"
    - "GET /api/documents/{id}/status returns lightweight status response"
    - "Custom exception handlers return consistent error format"
    - "Invalid requests return appropriate 4xx status codes"
  artifacts:
    - path: "backend/src/main.py"
      provides: "CORS middleware and exception handlers"
      contains: "CORSMiddleware"
    - path: "backend/src/api/documents.py"
      provides: "Document status endpoint"
      contains: "get_document_status"
    - path: "backend/src/api/errors.py"
      provides: "Custom API exceptions"
      contains: "class EntityNotFoundError"
  key_links:
    - from: "backend/src/main.py"
      to: "backend/src/api/documents.py"
      via: "app.include_router(documents_router)"
      pattern: "include_router.*documents"
    - from: "backend/src/main.py"
      to: "backend/src/api/errors.py"
      via: "from src.api.errors import EntityNotFoundError"
      pattern: "from src\\.api\\.errors import EntityNotFoundError"
---

<objective>
Add CORS middleware, custom exception handlers, and document status endpoint

Purpose: Complete the document API with status endpoint for polling, add CORS for frontend integration, and standardize error responses across all endpoints.

Output: Updated main.py with middleware/handlers, status endpoint in documents.py, errors.py module
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-storage-rest-api/04-RESEARCH.md

# Existing files to modify
@backend/src/main.py
@backend/src/api/documents.py
@backend/src/api/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create errors.py module with EntityNotFoundError</name>
  <files>backend/src/api/errors.py</files>
  <action>
Create backend/src/api/errors.py with custom API exceptions.

**File content:**
```python
"""Custom API exceptions."""


class EntityNotFoundError(Exception):
    """Raised when a requested entity is not found."""

    def __init__(self, entity_type: str, entity_id: str):
        self.entity_type = entity_type
        self.entity_id = entity_id
        super().__init__(f"{entity_type} not found: {entity_id}")
```

This module is created FIRST so main.py can import from it in Task 2.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.errors import EntityNotFoundError; e = EntityNotFoundError('Test', '123'); print(f'Created: {e}')"`
  </verify>
  <done>errors.py exists with EntityNotFoundError class</done>
</task>

<task type="auto">
  <name>Task 2: Add CORS middleware and exception handlers to main.py</name>
  <files>backend/src/main.py</files>
  <action>
Modify main.py to add CORS middleware and custom exception handlers.

**Add import at top:**
```python
from src.api.errors import EntityNotFoundError
```

**CORS Configuration (add BEFORE routers):**
```python
from fastapi.middleware.cors import CORSMiddleware

# Add immediately after app = FastAPI(...)
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",      # Next.js dev
        "http://localhost:5173",      # Vite dev
        "http://127.0.0.1:3000",
        "http://127.0.0.1:5173",
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["*"],
)
```

**Custom exception handlers:**

1. Add handler for EntityNotFoundError:
```python
from fastapi import Request
from fastapi.responses import JSONResponse

@app.exception_handler(EntityNotFoundError)
async def entity_not_found_handler(
    request: Request, exc: EntityNotFoundError
) -> JSONResponse:
    return JSONResponse(
        status_code=404,
        content={"detail": f"{exc.entity_type} not found: {exc.entity_id}"},
    )
```

2. Add generic exception handler for 500 errors:
```python
@app.exception_handler(Exception)
async def generic_exception_handler(
    request: Request, exc: Exception
) -> JSONResponse:
    # Log the error in production
    import structlog
    logger = structlog.get_logger()
    logger.error("Unhandled exception", exc_info=exc, path=request.url.path)
    return JSONResponse(
        status_code=500,
        content={"detail": "Internal server error"},
    )
```

**IMPORTANT:** CORS middleware MUST be added FIRST, before exception handlers and routers are registered. The order in FastAPI matters.
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.main import app; from src.api.errors import EntityNotFoundError; print('CORS:', [m.__class__.__name__ for m in app.user_middleware]); print('EntityNotFoundError handler registered:', EntityNotFoundError in app.exception_handlers)"`
This verifies both that CORSMiddleware is present AND that main.py imports EntityNotFoundError from errors.py for the exception handler.
  </verify>
  <done>main.py has CORSMiddleware added first, EntityNotFoundError imported from errors.py, exception handlers registered</done>
</task>

<task type="auto">
  <name>Task 3: Add document status endpoint and update dependencies.py</name>
  <files>backend/src/api/documents.py, backend/src/api/dependencies.py</files>
  <action>
**Add to documents.py:**

Add response model:
```python
class DocumentStatusResponse(BaseModel):
    """Lightweight status response for polling."""
    id: UUID
    status: str
    page_count: int | None = None
    error_message: str | None = None
```

Add endpoint (place BEFORE /{document_id} endpoint to avoid route conflicts):
```python
@router.get(
    "/{document_id}/status",
    response_model=DocumentStatusResponse,
    summary="Get document processing status",
    description="Lightweight endpoint for polling document status. Use this instead of GET /{id} when only status is needed.",
)
async def get_document_status(
    document_id: UUID,
    repository: DocumentRepoDep,
) -> DocumentStatusResponse:
    """Get document processing status.

    Args:
        document_id: Document UUID
        repository: DocumentRepository (injected)

    Returns:
        DocumentStatusResponse with status, page_count, error_message

    Raises:
        404: Document not found
    """
    document = await repository.get_by_id(document_id)
    if not document:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Document not found: {document_id}",
        )

    return DocumentStatusResponse(
        id=document.id,
        status=document.status.value,
        page_count=document.page_count,
        error_message=document.error_message,
    )
```

**Update dependencies.py:**

Add the import and re-export so it's easily accessible:
```python
# At the end of dependencies.py
from src.api.errors import EntityNotFoundError

__all__ = [
    "DBSession",
    "GCSClientDep",
    "DoclingProcessorDep",
    "DocumentRepoDep",
    "DocumentServiceDep",
    "EntityNotFoundError",
]
```
  </action>
  <verify>
Run: `cd /Users/gregorydickson/stackpoint/loan/backend && python -c "from src.api.documents import router; paths = [r.path for r in router.routes]; print('Status endpoint:', '/{document_id}/status' in paths); from src.api.dependencies import EntityNotFoundError; print('EntityNotFoundError re-exported from dependencies')"`
  </verify>
  <done>GET /api/documents/{id}/status endpoint exists, EntityNotFoundError re-exported from dependencies.py</done>
</task>

</tasks>

<verification>
1. errors.py importable: `python -c "from src.api.errors import EntityNotFoundError"`
2. CORS middleware active: `curl -I -X OPTIONS http://localhost:8000/api/documents/ -H "Origin: http://localhost:3000"` returns Access-Control headers
3. Status endpoint works: `python -c "from src.api.documents import router; print('/{document_id}/status' in [r.path for r in router.routes])"`
4. main.py imports from errors.py: `grep -q "from src.api.errors import EntityNotFoundError" backend/src/main.py && echo "Import verified"`
5. App starts: `uvicorn src.main:app --host 0.0.0.0 --port 8000` (Ctrl+C to stop)
</verification>

<success_criteria>
- errors.py module created with EntityNotFoundError class
- CORSMiddleware configured with localhost:3000 and localhost:5173 origins
- main.py imports EntityNotFoundError from src.api.errors (not defined inline)
- Exception handler for EntityNotFoundError returns 404 with consistent format
- Generic exception handler for 500 errors with logging
- GET /api/documents/{id}/status endpoint returns lightweight response
- EntityNotFoundError re-exported from dependencies.py for API module convenience
- All endpoints still work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-storage-rest-api/04-02-SUMMARY.md`
</output>
