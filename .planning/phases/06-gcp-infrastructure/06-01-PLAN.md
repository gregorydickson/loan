---
phase: 06-gcp-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/terraform/main.tf
  - infrastructure/terraform/variables.tf
  - infrastructure/terraform/vpc.tf
  - infrastructure/terraform/iam.tf
autonomous: true

must_haves:
  truths:
    - "Terraform init succeeds with GCS backend configuration"
    - "VPC network with private services access is defined"
    - "Service account with least-privilege roles is defined"
  artifacts:
    - path: "infrastructure/terraform/main.tf"
      provides: "Provider configuration and API enablement"
      contains: "google_project_service"
    - path: "infrastructure/terraform/variables.tf"
      provides: "Input variables for project_id, region, etc"
      contains: "variable"
    - path: "infrastructure/terraform/vpc.tf"
      provides: "VPC network with private IP for Cloud SQL"
      contains: "google_compute_network"
    - path: "infrastructure/terraform/iam.tf"
      provides: "Service account with roles"
      contains: "google_service_account"
  key_links:
    - from: "infrastructure/terraform/main.tf"
      to: "GCS backend"
      via: "terraform backend configuration"
      pattern: "backend.*gcs"
    - from: "infrastructure/terraform/vpc.tf"
      to: "infrastructure/terraform/main.tf"
      via: "depends on servicenetworking API"
      pattern: "depends_on.*google_project_service"
---

<objective>
Create the Terraform foundation for GCP infrastructure: provider configuration, variables, VPC networking with private services access, and IAM service accounts.

Purpose: Establish the foundational infrastructure components that Cloud SQL, Cloud Run, and other services will depend on. VPC with private IP eliminates public database exposure. Service accounts enable least-privilege access control.

Output: Terraform files for provider, variables, VPC, and IAM that pass `terraform validate`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gcp-infrastructure/06-RESEARCH.md
@.planning/phases/06-gcp-infrastructure/cd-scripts/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Terraform provider and variables configuration</name>
  <files>
    infrastructure/terraform/main.tf
    infrastructure/terraform/variables.tf
  </files>
  <action>
Create the infrastructure/terraform directory structure.

**infrastructure/terraform/main.tf:**
- Terraform settings block requiring >= 1.6.0
- GCS backend configuration for remote state (bucket name from variable)
- Google provider >= 7.0.0 with project and region from variables
- Enable required GCP APIs via google_project_service resources:
  - run.googleapis.com (Cloud Run)
  - sqladmin.googleapis.com (Cloud SQL)
  - secretmanager.googleapis.com (Secret Manager)
  - cloudtasks.googleapis.com (Cloud Tasks)
  - servicenetworking.googleapis.com (VPC peering)
  - artifactregistry.googleapis.com (Container registry)
  - compute.googleapis.com (VPC networking)
- Use disable_dependent_services = false and disable_on_destroy = false for all APIs

**infrastructure/terraform/variables.tf:**
- project_id (string, required): GCP project ID
- region (string, default "us-central1"): Deployment region
- db_password (string, sensitive, required): Database password
- gemini_api_key (string, sensitive, required): Gemini API key for extraction
- image_tag (string, default "latest"): Docker image tag for deployments
- environment (string, default "prod"): Environment name for resource naming

Include descriptions for all variables. Mark sensitive variables appropriately.
  </action>
  <verify>
cd infrastructure/terraform && terraform init -backend=false && terraform validate
  </verify>
  <done>
main.tf has provider config with all 7 required APIs. variables.tf has 6 variables including sensitive db_password and gemini_api_key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VPC network with private services access</name>
  <files>infrastructure/terraform/vpc.tf</files>
  <action>
Create VPC configuration for private Cloud SQL connectivity.

**infrastructure/terraform/vpc.tf:**

1. VPC Network (google_compute_network):
   - Name: "${var.project_id}-vpc"
   - auto_create_subnetworks = false (manual subnet control)

2. Subnet for Cloud Run (google_compute_subnetwork):
   - Name: "cloud-run-subnet"
   - Region: var.region
   - IP range: "10.0.0.0/24"
   - Network: reference to VPC
   - private_ip_google_access = true (for reaching GCP APIs)

3. Private IP allocation for Cloud SQL (google_compute_global_address):
   - Name: "private-ip-address"
   - purpose = "VPC_PEERING"
   - address_type = "INTERNAL"
   - prefix_length = 16
   - network = VPC reference

4. Private VPC connection (google_service_networking_connection):
   - network = VPC ID
   - service = "servicenetworking.googleapis.com"
   - reserved_peering_ranges = [private IP name]
   - depends_on = [google_project_service for servicenetworking API]

This enables Cloud SQL to use private IP, and Cloud Run direct VPC egress to reach it securely.
  </action>
  <verify>
cd infrastructure/terraform && terraform validate && grep -c "google_compute_network\|google_compute_subnetwork\|google_service_networking_connection" vpc.tf
  </verify>
  <done>
vpc.tf defines VPC network, subnet, private IP allocation, and service networking connection. terraform validate passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create IAM service accounts with least-privilege roles</name>
  <files>infrastructure/terraform/iam.tf</files>
  <action>
Create service account and role bindings for Cloud Run services.

**infrastructure/terraform/iam.tf:**

1. Service Account (google_service_account):
   - account_id = "loan-cloud-run"
   - display_name = "Loan Extraction Cloud Run Service Account"

2. Role bindings (google_project_iam_member) for the service account:
   - roles/cloudsql.client - Connect to Cloud SQL
   - roles/secretmanager.secretAccessor - Read secrets
   - roles/cloudtasks.enqueuer - Create Cloud Tasks
   - roles/logging.logWriter - Write logs (implicit but explicit is cleaner)

3. Storage bucket IAM (will be added in Plan 03 after bucket creation, but add a local for the service account email to reference):
   - Export service account email as local value for other files

Note: Use google_project_iam_member (not google_project_iam_binding) to avoid overwriting other bindings. Each role gets its own resource.

Following least-privilege principle: only grant permissions the backend actually needs.
  </action>
  <verify>
cd infrastructure/terraform && terraform validate && grep -c "google_service_account\|google_project_iam_member" iam.tf
  </verify>
  <done>
iam.tf defines service account with 4 role bindings (cloudsql.client, secretmanager.secretAccessor, cloudtasks.enqueuer, logging.logWriter). terraform validate passes.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd infrastructure/terraform && terraform init -backend=false` succeeds
2. `terraform validate` passes with no errors
3. `terraform fmt -check` passes (files are formatted)
4. All 4 Terraform files exist with expected resources
</verification>

<success_criteria>
- [ ] infrastructure/terraform/ directory exists with main.tf, variables.tf, vpc.tf, iam.tf
- [ ] terraform validate passes
- [ ] main.tf enables 7 required GCP APIs
- [ ] variables.tf has project_id, region, db_password (sensitive), gemini_api_key (sensitive), image_tag, environment
- [ ] vpc.tf creates VPC, subnet, private IP allocation, and service networking connection
- [ ] iam.tf creates service account with 4 IAM role bindings
</success_criteria>

<output>
After completion, create `.planning/phases/06-gcp-infrastructure/06-01-SUMMARY.md`
</output>
