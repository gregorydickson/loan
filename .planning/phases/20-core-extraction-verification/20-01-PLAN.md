---
phase: 20-core-extraction-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Database-url secret points to loan_extraction database"
    - "Gemini API key secret contains real key from Google AI Studio"
    - "Backend /api/documents/ endpoint returns 200 (not 500)"
  artifacts:
    - path: "Secret Manager: database-url"
      provides: "Database connection for loan application"
    - path: "Secret Manager: gemini-api-key"
      provides: "Gemini API authentication for LangExtract"
  key_links:
    - from: "database-url secret"
      to: "loan-backend-prod"
      via: "--set-secrets mounting"
    - from: "gemini-api-key secret"
      to: "loan-backend-prod"
      via: "--set-secrets mounting"
---

<objective>
Resolve production configuration blockers so extraction verification can succeed.

Purpose: Phase 19 deployed services but database and API key were left as placeholders. These must be configured before any extraction testing can pass.

Output: Working API endpoints (no 500 errors) and functional LangExtract extraction
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-core-extraction-verification/20-RESEARCH.md
@.planning/phases/19-production-deployment-verification/19-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 1: Choose database configuration approach</name>
  <decision>How should the database-url secret be configured?</decision>
  <context>
    The database-url secret currently contains a placeholder value. Phase 19 deployed the backend but left database configuration incomplete. We need a working PostgreSQL database connection.

    Current Cloud SQL instance: memorygraph-db (memorygraph-prod:us-central1:memorygraph-db)
  </context>
  <options>
    <option id="option-a">
      <name>Create new database on existing Cloud SQL instance</name>
      <pros>Clean slate, isolated from other apps, appropriate for loan-specific data</pros>
      <cons>Requires Cloud SQL connection to create database</cons>
      <steps>
        1. Connect to Cloud SQL: `gcloud sql connect memorygraph-db --user=postgres`
        2. Create database: `CREATE DATABASE loan_extraction;`
        3. Update secret with connection string
      </steps>
    </option>
    <option id="option-b">
      <name>Use existing database with migrations</name>
      <pros>Faster if database already exists, no new setup</pros>
      <cons>May conflict with existing tables, need to verify schema</cons>
      <steps>
        1. Identify existing database name
        2. Update secret with connection string
        3. Run migrations if needed
      </steps>
    </option>
  </options>
  <resume-signal>
    Type "option-a" to create a new loan_extraction database.
    Type "option-b: [database_name]" to use an existing database.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Configure database connection based on user choice</name>
  <files>Secret Manager: database-url</files>
  <action>
    Based on user's decision from Task 1, configure the database:

    **If option-a (create new database):**
    ```bash
    # Connect to Cloud SQL and create database
    gcloud sql connect memorygraph-db --user=postgres
    # In psql: CREATE DATABASE loan_extraction;

    # Then update secret with correct connection string
    DB_URL="postgresql+asyncpg://postgres:PASSWORD@/loan_extraction?host=/cloudsql/memorygraph-prod:us-central1:memorygraph-db"
    echo "$DB_URL" | gcloud secrets versions add database-url --data-file=-
    ```

    **If option-b (use existing database):**
    Update connection string with user-specified database name.

    **After update:**
    1. Check secret has new version: `gcloud secrets versions list database-url`
    2. Note: Backend may need restart or new deployment to pick up secret change
    3. If needed: `gcloud run services update loan-backend-prod --region us-central1`

    **Do NOT:** Hardcode passwords in plan output - ask user for credentials if needed.
  </action>
  <verify>
    ```bash
    # Verify secret updated
    gcloud secrets versions list database-url

    # Test API endpoint (may need a minute for service restart)
    curl -s "https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/api/documents/"
    # Expected: 200 with JSON response, NOT 500 error
    ```
  </verify>
  <done>
    - Secret database-url has new version
    - GET /api/documents/ returns 200 with JSON (empty list is fine)
    - No 500 "Internal server error" responses
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Provide Gemini API key</name>
  <action>
    The gemini-api-key secret currently contains "PLACEHOLDER" which will cause LangExtract extraction to fail.

    **User action required:**
    1. Go to https://makersuite.google.com/app/apikey (Google AI Studio)
    2. Create or copy an existing API key
    3. Provide the key to Claude for secret update

    **Why Claude cannot do this:** API keys are user credentials that must be retrieved from the user's own Google account.
  </action>
  <instructions>
    1. Navigate to https://makersuite.google.com/app/apikey
    2. Sign in with your Google account
    3. Click "Create API key" or copy existing key
    4. Paste the API key below
  </instructions>
  <resume-signal>Paste your Gemini API key, then Claude will update the secret</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Update Gemini API key secret</name>
  <files>Secret Manager: gemini-api-key</files>
  <action>
    After user provides API key, update the secret:

    ```bash
    # Update the secret with user-provided key
    echo "USER_PROVIDED_KEY" | gcloud secrets versions add gemini-api-key --data-file=-

    # Verify update
    gcloud secrets versions list gemini-api-key
    ```

    **After update:**
    - Backend will pick up new secret on next request (Cloud Run secret mounting is dynamic for version: latest)
    - If not working, may need service update to force refresh

    **Test LangExtract is working:**
    Use FastAPI docs UI to test extraction endpoint with method=langextract
  </action>
  <verify>
    ```bash
    # Verify secret updated
    gcloud secrets versions list gemini-api-key
    # Should show new version with "enabled" status
    ```
  </verify>
  <done>
    - Secret gemini-api-key has new version with real key
    - Old "PLACEHOLDER" version disabled
    - Ready for LangExtract extraction testing
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Database connectivity:
   ```bash
   curl -s "https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/api/documents/" | jq .
   # Expected: {"documents":[],"total":0,...} NOT 500 error
   ```

2. Secrets configured:
   ```bash
   gcloud secrets versions list database-url
   gcloud secrets versions list gemini-api-key
   # Both should have recent versions with "enabled" status
   ```
</verification>

<success_criteria>
- [ ] database-url secret points to working loan database
- [ ] /api/documents/ returns 200 (not 500)
- [ ] gemini-api-key secret contains real API key (not placeholder)
- [ ] Both secrets have new versions listed in Secret Manager
</success_criteria>

<output>
After completion, create `.planning/phases/20-core-extraction-verification/20-01-SUMMARY.md`

Include:
- Database configuration method used (option-a or option-b)
- Secret version numbers
- Any service restarts needed
- API endpoint test results
</output>
