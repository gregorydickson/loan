---
phase: 20-core-extraction-verification
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Docling extraction processes document and returns structured borrower data"
    - "LangExtract extraction processes document and returns data with character offsets"
    - "Scanned document triggers GPU OCR service and extracts text"
  artifacts: []
  key_links:
    - from: "Frontend method selector"
      to: "Backend extraction router"
      via: "method query parameter"
    - from: "Backend extraction"
      to: "GPU OCR service"
      via: "HTTP call when ocr=force or scanned detected"
---

<objective>
Verify both extraction methods work end-to-end and GPU OCR processes scanned documents.

Purpose: Covers TEST-03 (Docling), TEST-04 (LangExtract), and TEST-05 (GPU OCR) requirements. These test the core extraction functionality that is the primary value of the application.

Output: Evidence that all extraction paths work correctly in production
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-core-extraction-verification/20-RESEARCH.md
@.planning/phases/20-core-extraction-verification/20-01-SUMMARY.md
@.planning/phases/20-core-extraction-verification/20-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify Docling extraction end-to-end (TEST-03)</name>
  <what-built>
    Docling extraction pipeline:
    - Uses Docling library for PDF parsing
    - Extracts borrower data (name, employer, income, etc.)
    - Returns structured JSON with extraction results
    - extraction_method field shows "docling"

    Note: Document uploaded in 20-02 with method=docling already tested basic upload.
    This task verifies the extraction RESULTS are correct.
  </what-built>
  <how-to-verify>
    1. In Chrome, navigate to Documents page
    2. Find the document uploaded in 20-02 (or upload a new one with method=docling)
    3. Click on document to view details
    4. Verify extraction results:
       - [ ] Status shows "completed"
       - [ ] extraction_method shows "docling"
       - [ ] Borrower data was extracted (check Borrowers page or document details)
       - [ ] For paystub: expect employer name, pay period, amounts
    5. Navigate to Borrowers page
    6. Verify:
       - [ ] Borrower record exists (created from extraction)
       - [ ] Borrower name matches document (e.g., "John Homeowner")

    Alternative verification via API:
    ```bash
    # Get document details (replace DOC_ID with actual ID from 20-02)
    curl -s "https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/api/documents/DOC_ID" | jq .
    # Check extraction_method, status, extracted data
    ```
  </how-to-verify>
  <resume-signal>
    Type "TEST-03 PASS" if Docling extraction returned structured borrower data.
    Type "TEST-03 FAIL: [description]" if extraction failed or returned no data.
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify LangExtract extraction with character offsets (TEST-04)</name>
  <what-built>
    LangExtract extraction pipeline:
    - Uses LangChain with Gemini API for extraction
    - Returns data WITH character offsets (char_start, char_end)
    - Enables text highlighting in UI
    - extraction_method field shows "langextract"

    Test document:
    loan-docs/Loan 214/W2 2024- John Homeowner.pdf (181KB)
    Or any document not yet uploaded with LangExtract method.
  </what-built>
  <how-to-verify>
    1. In Chrome, navigate to Documents page
    2. In the upload zone, select method: **langextract**
    3. Keep OCR mode as "auto"
    4. Upload: loan-docs/Loan 214/W2 2024- John Homeowner.pdf
    5. Wait for processing (may take 30-60 seconds for Gemini API call)
    6. Once status shows "completed", verify:
       - [ ] extraction_method shows "langextract"
       - [ ] Document has extracted fields
    7. Check for character offsets (critical for LangExtract):
       - View document details or use API
       - Each extracted field should have char_start and char_end
       ```bash
       curl -s "https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/api/documents/DOC_ID" | jq '.extractions'
       # Expected: fields with char_start, char_end values (not null)
       ```
    8. Verify offsets are reasonable:
       - [ ] char_start is a positive integer
       - [ ] char_end > char_start
       - [ ] Offsets reference actual character positions in document text
  </how-to-verify>
  <resume-signal>
    Type "TEST-04 PASS" if LangExtract extraction returned data with character offsets.
    Type "TEST-04 FAIL: [description]" if extraction failed or offsets missing.

    Include sample of offset data (e.g., {"field":"employer","char_start":123,"char_end":145})
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify GPU OCR service processes scanned document (TEST-05)</name>
  <what-built>
    GPU OCR service (LightOnOCR):
    - Cloud Run service with NVIDIA L4 GPU
    - Scale-to-zero enabled (may have 60-120s cold start)
    - Processes scanned/image-based PDFs
    - Returns extracted text for further processing

    Trigger OCR by:
    - Uploading scanned document, OR
    - Using ocr=force on any document (forces OCR even for native PDFs)

    Service URL: https://lightonocr-gpu-fjz2snvxjq-uc.a.run.app
  </what-built>
  <how-to-verify>
    Option A - Force OCR on native PDF (simpler):
    1. Navigate to Documents page
    2. Select method: docling (or langextract)
    3. Select OCR mode: **force** (this triggers GPU OCR regardless of PDF type)
    4. Upload any test document
    5. Observe:
       - [ ] Status shows "processing" initially
       - [ ] After 1-3 minutes (GPU cold start), status changes to "completed"
       - [ ] If >5 minutes, check Cloud Logging for GPU service errors
    6. Verify OCR was used:
       - Document should show ocr_processed: true
       ```bash
       curl -s "https://loan-backend-prod-fjz2snvxjq-uc.a.run.app/api/documents/DOC_ID" | jq '.ocr_processed'
       # Expected: true
       ```

    Option B - Use actual scanned document (if available):
    1. Same as above but use a scanned PDF
    2. With ocr=auto, system should detect it's scanned and trigger OCR

    GPU Service Health (optional check):
    ```bash
    curl -s "https://lightonocr-gpu-fjz2snvxjq-uc.a.run.app/health"
    # Expected: 200 (may take time if cold start)
    ```

    IMPORTANT: GPU cold start can take 60-120 seconds on first request.
    Wait patiently - this is expected behavior with scale-to-zero.
  </how-to-verify>
  <resume-signal>
    Type "TEST-05 PASS" if GPU OCR processed document successfully.
    Type "TEST-05 FAIL: [description]" if OCR failed or timed out.

    Include processing time observed (e.g., "cold start: 90s, processing: 15s")
  </resume-signal>
</task>

</tasks>

<verification>
Requirements verification:

| Requirement | Test | Expected Result |
|-------------|------|-----------------|
| TEST-03 | Docling extraction | Structured borrower data extracted |
| TEST-04 | LangExtract extraction | Data with char_start/char_end offsets |
| TEST-05 | GPU OCR | Scanned/forced doc shows ocr_processed=true |

All three must pass for Phase 20 completion.
</verification>

<success_criteria>
- [ ] TEST-03 PASS: Docling extracts structured borrower data
- [ ] TEST-04 PASS: LangExtract extracts data with character offsets
- [ ] TEST-05 PASS: GPU OCR processes document (ocr_processed=true)
- [ ] Borrowers page shows extracted borrower(s)
- [ ] Multiple documents uploaded with different methods all show "completed"
</success_criteria>

<output>
After completion, create `.planning/phases/20-core-extraction-verification/20-03-SUMMARY.md`

Include:
- TEST-03, TEST-04, TEST-05 results
- Document IDs used for each test
- Sample extraction data (especially LangExtract offsets)
- GPU cold start timing observed
- Any issues encountered
- Phase 20 completion summary (all 5 TEST requirements)
</output>
