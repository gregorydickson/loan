---
phase: 20-core-extraction-verification
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/ocr/ocr_router.py
  - backend/tests/unit/ocr/test_ocr_router.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Scanned document triggers GPU OCR service and extracts text successfully"
    - "GPU OCR results are merged back into document content"
    - "Fallback to Docling OCR still works when GPU unavailable"
  artifacts:
    - path: "backend/src/ocr/ocr_router.py"
      provides: "GPU OCR integration wiring"
      contains: "_ocr_pages_with_gpu"
    - path: "backend/tests/unit/ocr/test_ocr_router.py"
      provides: "Tests for GPU OCR integration"
      exports: ["test_scanned_pdf_uses_gpu_ocr"]
  key_links:
    - from: "backend/src/ocr/ocr_router.py"
      to: "gpu_client.extract_text"
      via: "_ocr_pages_with_gpu method"
      pattern: "await self._ocr_pages_with_gpu"
---

<objective>
Wire GPU OCR integration in OCRRouter to actually call the GPU service for scanned document pages

Purpose: Close gap identified in Phase 20 verification - GPU service deployed but never invoked for actual document OCR processing. TEST-05 requirement "GPU OCR service processes scanned document" is blocked.

Output: Backend OCRRouter calls GPU service extract_text() for scanned pages, merges OCR text back into document content, and passes TEST-05 verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-core-extraction-verification/20-VERIFICATION.md

# Gap analysis shows:
# 1. GPU service infrastructure complete and healthy
# 2. LightOnOCRClient code complete at backend/src/ocr/lightonocr_client.py
# 3. OCRRouter._try_gpu_ocr() and ._ocr_pages_with_gpu() methods exist but bypassed
# 4. Lines 255-264 of ocr_router.py do health check then fall back to Docling
# 5. Need to wire actual GPU OCR call path

@backend/src/ocr/ocr_router.py
@backend/src/ocr/lightonocr_client.py
@backend/tests/unit/ocr/test_ocr_router.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire GPU OCR integration in OCRRouter</name>
  <files>backend/src/ocr/ocr_router.py</files>
  <action>
Modify the process() method in OCRRouter to actually use GPU OCR for scanned pages instead of falling back to Docling.

The existing code at lines 245-264:
1. Checks GPU health
2. Logs "GPU service healthy, using Docling OCR for full document"
3. Falls back to Docling OCR immediately

Change this to:
1. Check GPU health (keep)
2. If healthy, call _ocr_pages_with_gpu() to OCR scanned pages via GPU
3. Merge OCR text results into document content
4. Return OCRResult with ocr_method="gpu"
5. On GPU failure, fall back to Docling OCR (keep existing fallback)

Implementation approach:
- After GPU health check passes, call self._ocr_pages_with_gpu(pdf_bytes, detection.scanned_pages)
- For each page, GPU returns text; need to merge into DocumentContent
- Create _merge_ocr_results() helper method to combine GPU OCR text with existing DocumentContent
- The DocumentContent dataclass has full_text and pages fields - update appropriately
- Preserve circuit breaker protection (already wraps _try_gpu_ocr)

Key code change in process() method around line 255:
```python
# GPU is healthy - use GPU OCR for scanned pages
logger.info("GPU service healthy, using GPU OCR for %d pages", len(detection.scanned_pages))
ocr_texts = await self._ocr_pages_with_gpu(pdf_bytes, detection.scanned_pages)

# Merge OCR results into document content
content = self._merge_ocr_results(pdf_bytes, filename, ocr_texts, detection.scanned_pages)
return OCRResult(
    content=content,
    ocr_method="gpu",
    pages_ocrd=detection.scanned_pages,
)
```

Add new method _merge_ocr_results():
- Takes pdf_bytes, filename, ocr_texts dict, scanned_pages list
- Process non-scanned pages with Docling (no OCR)
- Replace scanned pages content with GPU OCR results
- Combine into unified DocumentContent

Remove the "Phase 15 will wire" comment since we're completing the integration now.
  </action>
  <verify>
Run unit tests: `cd /Users/gregorydickson/stackpoint/loan && python -m pytest backend/tests/unit/ocr/test_ocr_router.py -v`
Verify no syntax errors: `cd /Users/gregorydickson/stackpoint/loan && python -c "from src.ocr.ocr_router import OCRRouter"`
  </verify>
  <done>
OCRRouter.process() calls GPU service for scanned pages when GPU is healthy, with ocr_method="gpu" in result
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for GPU OCR integration</name>
  <files>backend/tests/unit/ocr/test_ocr_router.py</files>
  <action>
Add test case to verify GPU OCR is actually invoked (not just health checked) when processing scanned documents.

Add new test method test_scanned_pdf_uses_gpu_ocr():
```python
@pytest.mark.asyncio
async def test_scanned_pdf_uses_gpu_ocr(
    self, router, mock_detector, mock_gpu_client, mock_docling
):
    """Test that scanned PDF pages are sent to GPU OCR service."""
    # Arrange
    pdf_bytes = b"fake pdf content"
    mock_detector.detect.return_value = DetectionResult(
        needs_ocr=True,
        scanned_pages=[0, 1],
        total_pages=2,
        scanned_ratio=1.0,
    )
    mock_gpu_client.health_check.return_value = True
    mock_gpu_client.extract_text.return_value = "OCR extracted text from GPU"

    # Act
    result = await router.process(pdf_bytes, "scanned.pdf", mode="auto")

    # Assert
    assert result.ocr_method == "gpu"
    assert result.pages_ocrd == [0, 1]
    # Verify GPU extract_text was actually called (not just health_check)
    assert mock_gpu_client.extract_text.called
    assert mock_gpu_client.extract_text.call_count == 2  # Once per scanned page
```

Update existing tests if they assume Docling fallback when GPU is healthy - they should now expect GPU OCR to be used.

Review and update test_scanned_pdf_gpu_healthy_uses_docling_ocr if it exists - rename or update expectations.
  </action>
  <verify>
Run full OCR router test suite: `cd /Users/gregorydickson/stackpoint/loan && python -m pytest backend/tests/unit/ocr/test_ocr_router.py -v`
Confirm new test passes and existing tests don't regress
  </verify>
  <done>
Test suite passes with new test_scanned_pdf_uses_gpu_ocr confirming GPU OCR is called
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy and verify GPU OCR in production</name>
  <files>None (deployment only)</files>
  <action>
Deploy updated backend to production and verify TEST-05:

1. Build and deploy backend:
```bash
cd /Users/gregorydickson/stackpoint/loan
gcloud builds submit --config=backend/cloudbuild.yaml --substitutions=_SERVICE_NAME=loan-backend-prod
```

2. Wait for deployment to complete

3. Test GPU OCR end-to-end:
- Upload a scanned PDF document via frontend with ocr=force
- Check backend logs for "using GPU OCR" message
- Verify extraction completes successfully

4. Verify TEST-05 passes:
- Scanned document triggers GPU OCR service
- GPU service processes the document
- Extracted text returned to extraction pipeline

Note: If deployment fails due to unrelated issues, focus on fixing the code changes. Deployment verification can be done manually.
  </action>
  <verify>
Check Cloud Run logs: `gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=loan-backend-prod AND textPayload:GPU" --limit=10 --format="table(timestamp,textPayload)"`
Verify GPU OCR invoked in production logs
  </verify>
  <done>
Backend deployed with GPU OCR integration, logs show GPU service being called for scanned documents
  </done>
</task>

</tasks>

<verification>
## Gap Closure Verification

After all tasks complete:

1. **Code verification:**
   - OCRRouter.process() calls GPU service extract_text() for scanned pages
   - No "Phase 15 will wire" comments remain in ocr_router.py
   - Test coverage confirms GPU OCR path is exercised

2. **TEST-05 verification:**
   - Upload scanned document with ocr=force
   - Backend logs show "using GPU OCR"
   - GPU service receives requests (check GPU service logs if needed)
   - Extraction result contains text from scanned pages

3. **Fallback verification:**
   - Verify Docling fallback still works when GPU unhealthy
   - Circuit breaker protection intact
</verification>

<success_criteria>
- [ ] OCRRouter._ocr_pages_with_gpu() called when GPU is healthy and document has scanned pages
- [ ] OCRResult.ocr_method == "gpu" when GPU OCR used successfully
- [ ] Test test_scanned_pdf_uses_gpu_ocr passes
- [ ] Backend unit tests pass (no regressions)
- [ ] Production deployment shows GPU OCR invocation in logs
- [ ] TEST-05 requirement "GPU OCR service processes scanned document" is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/20-core-extraction-verification/20-04-SUMMARY.md`
</output>
