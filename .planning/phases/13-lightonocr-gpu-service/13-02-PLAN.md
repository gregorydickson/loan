---
phase: 13-lightonocr-gpu-service
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified: []
autonomous: false
user_setup:
  - service: gcp-cloud-run
    why: "GPU service deployment requires authenticated gcloud"
    env_vars: []
    dashboard_config:
      - task: "Verify GPU quota is available"
        location: "GCP Console -> IAM & Admin -> Quotas -> Filter: nvidia_l4"

must_haves:
  truths:
    - "LightOnOCR Cloud Run GPU service is deployed and running"
    - "Service URL is accessible with authentication"
    - "Health endpoint returns success"
  artifacts: []
  key_links:
    - from: "deploy.sh"
      to: "Cloud Run"
      via: "gcloud run deploy"
      pattern: "Service URL: https://.*run.app"
---

<objective>
Deploy LightOnOCR GPU service to Cloud Run

Purpose: Execute deployment of GPU service using artifacts from Plan 01, verify service health
Output: Running Cloud Run GPU service with accessible URL
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-lightonocr-gpu-service/13-01-SUMMARY.md
@.planning/phases/13-lightonocr-gpu-service/13-RESEARCH.md
@infrastructure/lightonocr-gpu/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute GPU service deployment</name>
  <files></files>
  <action>
Run the deployment script created in Plan 01 to deploy LightOnOCR to Cloud Run GPU.

Steps:
1. First, run the service account setup script:
   ```bash
   cd /Users/gregorydickson/stackpoint/loan
   bash infrastructure/scripts/setup-lightonocr-sa.sh
   ```

2. Then run the deployment script:
   ```bash
   bash infrastructure/lightonocr-gpu/deploy.sh
   ```

**Expected timing:**
- Docker build: 10-15 minutes (model download ~6GB)
- Docker push: 2-5 minutes
- Cloud Run deployment: 2-5 minutes
- Total: ~15-25 minutes

**Possible authentication gates:**
- If docker push fails with auth error: Run `gcloud auth configure-docker ${REGION}-docker.pkg.dev`
- If gcloud run deploy fails with quota error: Check GPU quota at GCP Console

**Capture the service URL from output** for use in subsequent plans.

If deployment fails due to quota or configuration issues, document the error and create a checkpoint.
  </action>
  <verify>
After deployment completes:
1. Note the SERVICE_URL from deploy script output
2. Run health check: `curl -sf ${SERVICE_URL}/health` (requires auth token)
3. For authenticated health check:
   ```bash
   TOKEN=$(gcloud auth print-identity-token)
   curl -sf -H "Authorization: Bearer $TOKEN" ${SERVICE_URL}/health
   ```
  </verify>
  <done>
- Deploy script completes successfully
- Cloud Run service is running (visible in GCP Console or via `gcloud run services list`)
- Service URL is captured for backend client configuration
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>LightOnOCR GPU service deployed to Cloud Run with L4 GPU, scale-to-zero, and service account authentication</what-built>
  <how-to-verify>
1. Go to GCP Console -> Cloud Run
2. Verify "lightonocr-gpu" service exists in us-central1
3. Check service details:
   - CPU: 8
   - Memory: 32 GiB
   - GPU: 1 x nvidia-l4
   - Min instances: 0
   - Max instances: 3
   - Authentication: Required (no unauthenticated access)

4. Optional: Test with curl (service may cold start ~2 min):
   ```bash
   SERVICE_URL=$(gcloud run services describe lightonocr-gpu --region us-central1 --format "value(status.url)")
   TOKEN=$(gcloud auth print-identity-token)
   curl -sf -H "Authorization: Bearer $TOKEN" "${SERVICE_URL}/health"
   ```

5. Check logs tab for any startup errors
  </how-to-verify>
  <resume-signal>Type "approved" if service is running and healthy, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `gcloud run services list --region us-central1` shows lightonocr-gpu
2. `gcloud run services describe lightonocr-gpu --region us-central1` shows GPU configuration
3. Health endpoint responds (with authentication)
</verification>

<success_criteria>
- Cloud Run GPU service deployed with L4 GPU (LOCR-01)
- vLLM serving LightOnOCR-2-1B model (LOCR-02)
- Service scales to zero (min_instances=0) (LOCR-04)
- Service requires authentication (LOCR-07)
- Service URL available for client configuration
</success_criteria>

<output>
After completion, create `.planning/phases/13-lightonocr-gpu-service/13-02-SUMMARY.md`

Include the SERVICE_URL in the summary for use by Plan 03 (client implementation).
</output>
