---
phase: 10-v2-setup-preparation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/cloudbuild/setup-service-account.sh
  - docs/cloudbuild-setup.md
autonomous: false

must_haves:
  truths:
    - "CloudBuild can deploy Cloud Run services with proper IAM permissions"
    - "Service account has least-privilege access (no Editor/Owner)"
    - "Setup process is documented and repeatable"
  artifacts:
    - path: "infrastructure/cloudbuild/setup-service-account.sh"
      provides: "Service account creation script"
      contains: "gcloud iam service-accounts create"
    - path: "docs/cloudbuild-setup.md"
      provides: "CloudBuild setup documentation"
      contains: "cloudbuild-deployer"
  key_links:
    - from: "cloudbuild-deployer service account"
      to: "Cloud Run services"
      via: "IAM roles/run.developer"
      pattern: "roles/run.developer"
---

<objective>
Create and configure CloudBuild service account with required IAM permissions (CBLD-08).

Purpose: CloudBuild needs a dedicated service account with least-privilege permissions for deploying Cloud Run services. This plan creates the script AND executes it to configure the actual service account in GCP.
Output: Executable setup script, documentation, and configured service account in GCP.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-v2-setup-preparation/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CloudBuild service account setup script</name>
  <files>infrastructure/cloudbuild/setup-service-account.sh</files>
  <action>
Create infrastructure/cloudbuild/ directory and setup-service-account.sh:

```bash
#!/bin/bash
# CloudBuild Service Account Setup
# Creates dedicated service account with least-privilege permissions for Cloud Run deployments
#
# Usage: ./setup-service-account.sh [PROJECT_ID]
# If PROJECT_ID not provided, uses gcloud default project

set -euo pipefail

PROJECT_ID="${1:-$(gcloud config get-value project 2>/dev/null)}"
if [[ -z "$PROJECT_ID" ]]; then
    echo "Error: No project ID provided and no default project set"
    echo "Usage: $0 PROJECT_ID"
    exit 1
fi

SA_NAME="cloudbuild-deployer"
SA_EMAIL="${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

echo "Setting up CloudBuild service account for project: $PROJECT_ID"

# Create service account (idempotent - will skip if exists)
if gcloud iam service-accounts describe "$SA_EMAIL" --project="$PROJECT_ID" &>/dev/null; then
    echo "Service account $SA_EMAIL already exists, skipping creation"
else
    echo "Creating service account: $SA_NAME"
    gcloud iam service-accounts create "$SA_NAME" \
        --project="$PROJECT_ID" \
        --display-name="CloudBuild Deployer Service Account" \
        --description="Service account for CloudBuild deployments to Cloud Run"
fi

# Required IAM roles for Cloud Run deployment
ROLES=(
    "roles/run.developer"              # Deploy Cloud Run services
    "roles/iam.serviceAccountUser"     # Act as runtime service account
    "roles/artifactregistry.writer"    # Push container images
    "roles/secretmanager.secretAccessor" # Read secrets during build
    "roles/logging.logWriter"          # Write build logs
)

echo "Granting IAM roles to $SA_EMAIL"
for role in "${ROLES[@]}"; do
    echo "  Granting: $role"
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
        --member="serviceAccount:${SA_EMAIL}" \
        --role="$role" \
        --condition=None \
        --quiet
done

echo ""
echo "CloudBuild service account setup complete!"
echo "Service account: $SA_EMAIL"
echo ""
echo "Roles granted:"
for role in "${ROLES[@]}"; do
    echo "  - $role"
done
echo ""
echo "Next steps:"
echo "  1. Configure CloudBuild triggers to use this service account"
echo "  2. Create cloudbuild.yaml files for each service"
```

Make the script executable: chmod +x infrastructure/cloudbuild/setup-service-account.sh
  </action>
  <verify>
    ls -la infrastructure/cloudbuild/setup-service-account.sh shows executable script
    head -20 infrastructure/cloudbuild/setup-service-account.sh shows correct header
  </verify>
  <done>CloudBuild service account setup script created</done>
</task>

<task type="auto">
  <name>Task 2: Create CloudBuild setup documentation</name>
  <files>docs/cloudbuild-setup.md</files>
  <action>
Create docs/cloudbuild-setup.md documenting the CloudBuild service account and setup process:

```markdown
# CloudBuild Setup Guide

## Service Account

CloudBuild uses a dedicated service account with least-privilege permissions.

**Service Account:** cloudbuild-deployer@PROJECT_ID.iam.gserviceaccount.com

### IAM Roles

| Role | Purpose |
|------|---------|
| roles/run.developer | Deploy and manage Cloud Run services |
| roles/iam.serviceAccountUser | Act as the Cloud Run runtime service account |
| roles/artifactregistry.writer | Push container images to Artifact Registry |
| roles/secretmanager.secretAccessor | Access secrets during builds (DB passwords, API keys) |
| roles/logging.logWriter | Write build logs to Cloud Logging |

### Setup

Run the setup script to create the service account:

```bash
./infrastructure/cloudbuild/setup-service-account.sh PROJECT_ID
```

The script is idempotent - safe to run multiple times.

## Directory Structure

```
infrastructure/
  cloudbuild/
    setup-service-account.sh  # Service account creation (this guide)
    backend.cloudbuild.yaml   # Backend deployment (Phase 16)
    frontend.cloudbuild.yaml  # Frontend deployment (Phase 16)
    gpu.cloudbuild.yaml       # GPU service deployment (Phase 16)
```

## Security Notes

- Uses dedicated service account, not legacy CloudBuild default
- Least-privilege: only roles needed for Cloud Run deployment
- No Editor or Owner roles granted
- Secrets accessed via Secret Manager, not build variables

## Related

- Phase 16: CloudBuild deployment configurations
- Phase 13: GPU service deployment (requires this SA)
```
  </action>
  <verify>cat docs/cloudbuild-setup.md shows complete documentation</verify>
  <done>CloudBuild setup documentation created</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Execute setup script to configure service account</name>
  <what-built>CloudBuild service account setup script and documentation</what-built>
  <how-to-verify>
1. Ensure you are authenticated to GCP: `gcloud auth list`
2. Set your project: `gcloud config set project YOUR_PROJECT_ID`
3. Run the setup script:
   ```bash
   ./infrastructure/cloudbuild/setup-service-account.sh
   ```
4. Verify the service account was created:
   ```bash
   gcloud iam service-accounts list --filter="email~cloudbuild-deployer"
   ```
5. Verify IAM roles are assigned:
   ```bash
   gcloud projects get-iam-policy YOUR_PROJECT_ID \
     --flatten="bindings[].members" \
     --filter="bindings.members~cloudbuild-deployer" \
     --format="table(bindings.role)"
   ```

Expected output: Service account exists with 5 IAM roles assigned.
  </how-to-verify>
  <resume-signal>Type "approved" with the service account email, or describe any errors encountered</resume-signal>
</task>

</tasks>

<verification>
- [ ] infrastructure/cloudbuild/setup-service-account.sh exists and is executable
- [ ] Script creates service account with 5 required IAM roles
- [ ] Script is idempotent (checks if SA exists before creating)
- [ ] docs/cloudbuild-setup.md documents the setup process
- [ ] Service account actually exists in GCP (CBLD-08 requirement)
- [ ] IAM roles are granted (verified via gcloud)
</verification>

<success_criteria>
CloudBuild service account is configured (CBLD-08):
1. Executable setup script in infrastructure/cloudbuild/
2. Script grants all 5 required IAM roles
3. Documentation in docs/cloudbuild-setup.md
4. Service account actually created in GCP with permissions granted
</success_criteria>

<output>
After completion, create `.planning/phases/10-v2-setup-preparation/10-03-SUMMARY.md`
</output>
