---
phase: 03-llm-extraction-validation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/src/extraction/validation.py
  - backend/src/extraction/confidence.py
  - backend/tests/extraction/test_validation.py
  - backend/tests/extraction/test_confidence.py
autonomous: true

must_haves:
  truths:
    - "SSN validation checks XXX-XX-XXXX format"
    - "Phone validation accepts various US formats via phonenumbers library"
    - "ZIP validation checks XXXXX and XXXXX-XXXX formats"
    - "Validation errors tracked with field, value, error_type, message"
    - "Confidence score ranges from 0.0 to 1.0"
    - "Records with confidence < 0.7 flagged for manual review"
    - "Confidence increases for complete required fields, optional fields, multi-source, validation"
  artifacts:
    - path: "backend/src/extraction/validation.py"
      provides: "FieldValidator with validate_ssn, validate_phone, validate_zip"
      exports: ["FieldValidator", "ValidationResult", "ValidationError"]
      min_lines: 100
    - path: "backend/src/extraction/confidence.py"
      provides: "ConfidenceCalculator with calculate() method"
      exports: ["ConfidenceCalculator", "ConfidenceBreakdown"]
      min_lines: 60
  key_links:
    - from: "backend/src/extraction/validation.py"
      to: "phonenumbers"
      via: "phone parsing and validation"
      pattern: "phonenumbers\\.parse"
    - from: "backend/src/extraction/confidence.py"
      to: "BorrowerRecord"
      via: "field completeness checks"
      pattern: "record\\.(name|address|income_history)"
---

<objective>
Create the validation and confidence scoring components for extracted borrower data.

Purpose: Ensure data quality - validate formats (SSN, phone, zip), calculate confidence scores to flag uncertain extractions for review
Output: FieldValidator for format checking, ConfidenceCalculator for scoring - both used by extraction orchestrator
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-llm-extraction--validation/03-RESEARCH.md
@backend/src/models/borrower.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rapidfuzz and phonenumbers dependencies</name>
  <files>
    backend/pyproject.toml
  </files>
  <action>
Add the following dependencies to the `dependencies` list in pyproject.toml:

```
"rapidfuzz>=3.0.0",
"phonenumbers>=8.0.0",
```

Add after the existing dependencies (before the closing bracket).

These are required for:
- `phonenumbers`: Robust US phone number validation (VALID-02)
- `rapidfuzz`: Fast fuzzy name matching for deduplication (needed in Plan 04)

Run `pip install -e ".[dev]"` to install.
  </action>
  <verify>
`cd backend && pip install -e ".[dev]" && python -c "import phonenumbers; import rapidfuzz; print('OK')"`
  </verify>
  <done>
rapidfuzz and phonenumbers added to dependencies and installable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FieldValidator for format validation</name>
  <files>
    backend/src/extraction/validation.py
    backend/tests/extraction/test_validation.py
  </files>
  <action>
Create `validation.py` with:

1. `ValidationError` dataclass:
   - `field: str` - Field name (ssn, phone, zip_code)
   - `value: str` - The invalid value
   - `error_type: str` - Error category (FORMAT, LENGTH, INVALID, NANP)
   - `message: str` - Human-readable error message

2. `ValidationResult` dataclass:
   - `is_valid: bool`
   - `errors: list[ValidationError] = field(default_factory=list)`
   - `warnings: list[str] = field(default_factory=list)`

3. `FieldValidator` class with compiled regex patterns:
   - `SSN_PATTERN = re.compile(r"^\d{3}-?\d{2}-?\d{4}$")` - With or without dashes
   - `SSN_FORMATTED = re.compile(r"^\d{3}-\d{2}-\d{4}$")` - With dashes
   - `ZIP_PATTERN = re.compile(r"^\d{5}(-\d{4})?$")`

Methods:
- `validate_ssn(self, ssn: str | None) -> ValidationResult`:
  - None returns valid (optional field)
  - Check SSN_PATTERN match, return FORMAT error if not
  - If valid but not SSN_FORMATTED, add warning about dashes

- `validate_phone(self, phone: str | None) -> ValidationResult`:
  - None returns valid
  - Use `phonenumbers.parse(phone, "US")` and `phonenumbers.is_valid_number()`
  - Handle `NumberParseException` -> FORMAT error
  - Invalid number -> INVALID error

- `validate_zip(self, zip_code: str | None) -> ValidationResult`:
  - None returns valid
  - Check ZIP_PATTERN match, return FORMAT error if not

Unit tests (test_validation.py):
- `test_ssn_valid_with_dashes` - "123-45-6789" is valid
- `test_ssn_valid_without_dashes` - "123456789" is valid with warning
- `test_ssn_invalid_format` - "12345" returns error
- `test_phone_valid_formats` - "(555) 123-4567", "555-123-4567", "+1 555 123 4567"
- `test_phone_invalid` - "123" returns error
- `test_zip_valid_5digit` - "12345" is valid
- `test_zip_valid_9digit` - "12345-6789" is valid
- `test_zip_invalid` - "1234" returns error
- `test_none_values_valid` - None for all fields returns valid
  </action>
  <verify>
`cd backend && python -m pytest tests/extraction/test_validation.py -v` passes
  </verify>
  <done>
FieldValidator validates SSN, phone, ZIP formats with detailed error tracking
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ConfidenceCalculator for scoring</name>
  <files>
    backend/src/extraction/confidence.py
    backend/tests/extraction/test_confidence.py
  </files>
  <action>
Create `confidence.py` with:

1. `ConfidenceBreakdown` dataclass:
   - `base_score: float` - Always 0.5
   - `required_fields_bonus: float` - Up to 0.2 (0.1 per required field)
   - `optional_fields_bonus: float` - Up to 0.15 (0.05 per optional field)
   - `multi_source_bonus: float` - 0.1 if source_count > 1
   - `validation_bonus: float` - 0.15 if all formats valid
   - `total: float` - Sum capped at 1.0
   - `requires_review: bool` - True if total < 0.7

2. `ConfidenceCalculator` class:
   - Class constants: `REVIEW_THRESHOLD = 0.7`, `BASE_SCORE = 0.5`

   - `calculate(self, record: BorrowerRecord, format_validation_passed: bool, source_count: int) -> ConfidenceBreakdown`:

     Required fields bonus (max 0.2):
     - +0.1 if record.name and len(record.name) > 1
     - +0.1 if record.address is not None

     Optional fields bonus (max 0.15):
     - +0.05 if record.income_history (non-empty)
     - +0.05 if record.account_numbers (non-empty)
     - +0.05 if record.loan_numbers (non-empty)
     - Cap at 0.15

     Multi-source bonus: +0.1 if source_count > 1
     Validation bonus: +0.15 if format_validation_passed

     Total = min(BASE + required + optional + multi + validation, 1.0)
     requires_review = total < REVIEW_THRESHOLD

Unit tests (test_confidence.py):
- `test_minimal_record_low_confidence` - Only name -> ~0.6
- `test_complete_record_high_confidence` - All fields + valid + multi-source -> 1.0
- `test_review_threshold` - Score 0.65 -> requires_review=True
- `test_no_review_above_threshold` - Score 0.75 -> requires_review=False
- `test_bonus_capped_at_max` - Can't exceed individual bonus caps
- `test_total_capped_at_one` - Total never exceeds 1.0
  </action>
  <verify>
`cd backend && python -m pytest tests/extraction/test_confidence.py -v` passes
  </verify>
  <done>
ConfidenceCalculator scores extractions and flags low-confidence records for review
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.extraction.validation import FieldValidator, ValidationResult"` - Import succeeds
2. `python -c "from src.extraction.confidence import ConfidenceCalculator, ConfidenceBreakdown"` - Import succeeds
3. `python -m pytest tests/extraction/test_validation.py tests/extraction/test_confidence.py -v` - All tests pass
4. Dependencies install: `pip install -e ".[dev]"` succeeds
</verification>

<success_criteria>
- FieldValidator validates SSN (XXX-XX-XXXX), phone (via phonenumbers), zip (XXXXX[-XXXX])
- ValidationResult tracks errors with detailed info (field, value, type, message)
- ConfidenceCalculator produces scores 0.0-1.0 based on field completeness
- Records with confidence < 0.7 flagged for review
- VALID-01 through VALID-06 and EXTRACT-25 through EXTRACT-29 requirements addressed
- 15+ unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-llm-extraction--validation/03-03-SUMMARY.md`
</output>
