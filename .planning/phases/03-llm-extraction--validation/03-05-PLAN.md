---
phase: 03-llm-extraction-validation
plan: 05
type: execute
wave: 2
depends_on: ["03-03", "03-04"]
files_modified:
  - backend/src/extraction/consistency.py
  - backend/src/extraction/extractor.py
  - backend/src/extraction/__init__.py
  - backend/tests/extraction/test_consistency.py
autonomous: true

must_haves:
  truths:
    - "Conflicting addresses for same borrower flagged as warning"
    - "Income progression validated for logical ordering (no drastic drops without explanation)"
    - "Cross-document data consistency checked (same borrower, different docs)"
    - "Consistency warnings included in ExtractionResult"
    - "Validation does not silently resolve conflicts - conflicts are reported for review"
  artifacts:
    - path: "backend/src/extraction/consistency.py"
      provides: "ConsistencyValidator with check methods"
      exports: ["ConsistencyValidator", "ConsistencyWarning"]
      min_lines: 100
    - path: "backend/src/extraction/extractor.py"
      provides: "BorrowerExtractor updated with consistency validation"
      contains: "consistency_validator"
      min_lines: 180
  key_links:
    - from: "backend/src/extraction/extractor.py"
      to: "backend/src/extraction/consistency.py"
      via: "ConsistencyValidator.validate() call after deduplication"
      pattern: "consistency_validator\\.validate"
    - from: "backend/src/extraction/consistency.py"
      to: "BorrowerRecord"
      via: "checks address and income_history fields"
      pattern: "record\\.(address|income_history)"
---

<objective>
Create ConsistencyValidator to detect and flag data inconsistencies across extracted borrower records.

Purpose: VALID-07, VALID-08, VALID-09 require detecting conflicts (not silently resolving them). This validates borrower data for logical consistency and flags issues for human review.
Output: ConsistencyValidator class that produces warnings for address conflicts, illogical income progression, and cross-document inconsistencies
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-llm-extraction--validation/03-RESEARCH.md
@backend/src/models/borrower.py
@backend/src/extraction/deduplication.py
@backend/src/extraction/extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConsistencyValidator class</name>
  <files>
    backend/src/extraction/consistency.py
    backend/tests/extraction/test_consistency.py
  </files>
  <action>
Create `consistency.py` with:

1. `ConsistencyWarning` dataclass:
   - `warning_type: str` - One of: ADDRESS_CONFLICT, INCOME_DROP, INCOME_SPIKE, CROSS_DOC_MISMATCH
   - `borrower_id: UUID` - Which borrower has the issue
   - `field: str` - Field with inconsistency (address, income_history)
   - `message: str` - Human-readable description
   - `details: dict` - Additional context (e.g., conflicting values, source documents)

2. `ConsistencyValidator` class:
   - `INCOME_DROP_THRESHOLD = 0.5` - Flag if income drops >50% year-over-year
   - `INCOME_SPIKE_THRESHOLD = 3.0` - Flag if income increases >300% year-over-year

   Methods:

   - `validate(self, borrowers: list[BorrowerRecord]) -> list[ConsistencyWarning]`:
     - For each borrower: run all checks
     - Return collected warnings

   - `check_address_conflicts(self, borrower: BorrowerRecord) -> list[ConsistencyWarning]`:
     - If borrower has multiple sources (len(borrower.sources) > 1):
       - This means the same borrower was found in multiple places
       - If the deduplicator merged records with different addresses, that's a conflict
       - Check if borrower.address differs from addresses in sources snippets (heuristic: look for different zip codes in snippets)
       - For simplicity: just flag if borrower has >1 source AND address exists
       - Warning type: ADDRESS_CONFLICT
       - Message: "Borrower {name} has multiple sources - verify address is correct"
       - Details: {"source_count": N, "current_address": {...}, "source_docs": [...]}

   - `validate_income_progression(self, borrower: BorrowerRecord) -> list[ConsistencyWarning]`:
     - Sort income_history by year
     - For consecutive years, calculate year-over-year change
     - If income drops > INCOME_DROP_THRESHOLD:
       - Warning type: INCOME_DROP
       - Message: "Income dropped {X}% from {year1} to {year2}"
       - Details: {"year1": Y1, "amount1": A1, "year2": Y2, "amount2": A2, "pct_change": X}
     - If income increases > INCOME_SPIKE_THRESHOLD:
       - Warning type: INCOME_SPIKE
       - Message: "Income increased {X}% from {year1} to {year2} - verify accuracy"
       - Details: same structure

   - `check_cross_document_consistency(self, borrowers: list[BorrowerRecord]) -> list[ConsistencyWarning]`:
     - Group borrowers by normalized name (lower, stripped)
     - For borrowers with same name but different IDs (not merged by deduplicator):
       - Compare SSN last 4 digits if both have SSN
       - If mismatch: warning that same name appears with different SSNs
       - Warning type: CROSS_DOC_MISMATCH
       - Message: "Multiple records for '{name}' with different identifiers - may be different people or data error"
       - Details: {"name": name, "record_ids": [...], "ssn_last4_values": [...]}

Unit tests (test_consistency.py):
- `test_no_warnings_for_clean_data` - Single source, stable income -> no warnings
- `test_address_conflict_multiple_sources` - Borrower with 3 sources flagged
- `test_income_drop_detected` - 60% income drop flagged
- `test_income_spike_detected` - 400% income increase flagged
- `test_stable_income_no_warning` - 10% change is fine
- `test_cross_doc_same_name_different_ssn` - Flagged for review
- `test_cross_doc_same_name_same_ssn` - Not flagged (correctly deduplicated)
- `test_validate_returns_all_warnings` - Combined test with multiple issues
  </action>
  <verify>
`cd backend && python -m pytest tests/extraction/test_consistency.py -v` passes
  </verify>
  <done>
ConsistencyValidator detects address conflicts, income anomalies, and cross-document mismatches
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ConsistencyValidator into BorrowerExtractor</name>
  <files>
    backend/src/extraction/extractor.py
    backend/src/extraction/__init__.py
  </files>
  <action>
Update `extractor.py`:

1. Update `ExtractionResult` dataclass to include consistency_warnings:
   - Add: `consistency_warnings: list[ConsistencyWarning] = field(default_factory=list)`

2. Update `BorrowerExtractor.__init__()`:
   - Add parameter: `consistency_validator: ConsistencyValidator`
   - Store as `self.consistency_validator`

3. Update `BorrowerExtractor.extract()` method:

   After Step 4 (deduplicate), add Step 4.5:
   ```python
   # Step 4.5: Check consistency
   consistency_warnings = self.consistency_validator.validate(merged)
   ```

   Update return statement to include consistency_warnings:
   ```python
   return ExtractionResult(
       borrowers=merged,
       complexity=assessment,
       chunks_processed=len(chunks),
       total_tokens=total_tokens,
       validation_errors=all_validation_errors,
       consistency_warnings=consistency_warnings,  # NEW
   )
   ```

4. Update `__init__.py` to export:
   - Add: `ConsistencyValidator`, `ConsistencyWarning`

NOTE: The consistency check runs AFTER deduplication. This is intentional:
- Deduplicator merges records that are definitely the same person (SSN match, account match, high name similarity)
- ConsistencyValidator flags records that MIGHT have issues (multiple sources, income anomalies, near-duplicate names)
- Merging is automatic; flagging is for human review
  </action>
  <verify>
`cd backend && python -m pytest tests/extraction/test_extractor.py -v` passes (verify no regressions)
`python -c "from src.extraction import ConsistencyValidator, ConsistencyWarning; print('OK')"` succeeds
  </verify>
  <done>
ConsistencyValidator integrated into extraction pipeline, warnings included in ExtractionResult
  </done>
</task>

<task type="auto">
  <name>Task 3: Add extractor integration tests for consistency</name>
  <files>
    backend/tests/extraction/test_extractor.py
  </files>
  <action>
Add integration tests to `test_extractor.py` (append to existing tests):

- `test_consistency_warnings_in_result`:
  - Create mock LLM response with borrower having income drop (2023: $100k, 2024: $30k)
  - Run extraction
  - Assert result.consistency_warnings is not empty
  - Assert at least one warning has type INCOME_DROP

- `test_multi_source_borrower_flagged`:
  - Create scenario where deduplicator merges two records (same SSN)
  - Run extraction
  - Assert result.consistency_warnings contains ADDRESS_CONFLICT warning
  - (Because merged borrower has multiple sources)

- `test_clean_extraction_no_warnings`:
  - Create simple single-borrower, single-source extraction
  - Assert result.consistency_warnings is empty
  </action>
  <verify>
`cd backend && python -m pytest tests/extraction/test_extractor.py -v -k consistency` passes
  </verify>
  <done>
Extractor integration tests verify consistency validation is wired correctly
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.extraction import ConsistencyValidator, ConsistencyWarning"` - Import succeeds
2. `python -c "from src.extraction import ExtractionResult; print(ExtractionResult.__dataclass_fields__.keys())"` - Shows consistency_warnings field
3. `python -m pytest tests/extraction/test_consistency.py tests/extraction/test_extractor.py -v` - All tests pass
</verification>

<success_criteria>
- ConsistencyValidator.check_address_conflicts() flags multi-source borrowers (VALID-09)
- ConsistencyValidator.validate_income_progression() flags income drops >50% and spikes >300% (VALID-08)
- ConsistencyValidator.check_cross_document_consistency() flags same-name different-SSN records (VALID-07)
- ExtractionResult includes consistency_warnings list
- BorrowerExtractor.extract() calls ConsistencyValidator after deduplication
- VALID-07, VALID-08, VALID-09 requirements addressed
- 11+ new unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/03-llm-extraction--validation/03-05-SUMMARY.md`
</output>
